<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veritable Games - Data Navigation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Enhanced UI styles and scripts -->
    <link rel="stylesheet" href="basic-enhanced.css">
    <script src="basic-enhanced.js" defer></script>
    <!-- Wiki links support -->
    <script src="wiki-links.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600;700&family=Montserrat:wght@400;500;700&display=swap');
        
        /* Improved Wiki Content Formatting */
        .wiki-content h1, .wiki-content h2, .wiki-content h3, .wiki-content h4, .wiki-content h5, .wiki-content h6 {
            margin-top: 1.8em;
            margin-bottom: 0.8em;
            color: #14418B;
            font-weight: 700;
            line-height: 1.3;
        }
        
        .wiki-content h1 {
            font-size: 2rem;
            padding-bottom: 0.4em;
            border-bottom: 2px solid #dce3f0;
            color: #0a2859;
            margin-top: 1em;
        }
        
        .wiki-content h2 {
            font-size: 1.6rem;
            padding-bottom: 0.4em;
            border-bottom: 1px solid #eaecf0;
            color: #14418B;
            background-color: #f8fafd;
            padding: 8px 12px;
            border-radius: 4px;
        }
        
        .wiki-content h3 {
            font-size: 1.3rem;
            color: #2e5cb8;
            border-left: 3px solid #2e5cb8;
            padding-left: 10px;
            padding-top: 3px;
            padding-bottom: 3px;
        }
        
        .wiki-content h4 {
            font-size: 1.1rem;
            color: #444;
            font-weight: 600;
            text-decoration: underline;
            text-decoration-color: #dce3f0;
            text-decoration-thickness: 2px;
            text-underline-offset: 5px;
        }
        
        .wiki-content p {
            margin-bottom: 1.2em;
            line-height: 1.6;
        }
        
        /* Add section spacing */
        .wiki-content h1 + p,
        .wiki-content h2 + p,
        .wiki-content h3 + p {
            margin-top: 0.8em;
        }
        
        /* Visual separators between sections */
        .wiki-content h2:not(:first-child) {
            margin-top: 2.5em;
            padding-top: 1em;
        }
        
        .wiki-content ul, .wiki-content ol {
            margin-bottom: 1.2em;
            padding-left: 2em;
        }
        
        .wiki-content li {
            margin-bottom: 0.5em;
        }
        
        .wiki-content code {
            background-color: #f6f8fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 90%;
            color: #24292e;
        }
        
        .wiki-content pre {
            background-color: #f6f8fa;
            padding: 1em;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 1.2em;
            border: 1px solid #eaecf0;
        }
        
        .wiki-content pre code {
            background-color: transparent;
            padding: 0;
            display: block;
            line-height: 1.5;
        }
        
        .wiki-content blockquote {
            margin-left: 0;
            margin-right: 0;
            padding: 0.8em 1.2em;
            border-left: 4px solid #2e5cb8;
            background-color: #f8fafd;
            color: #444;
            border-radius: 0 4px 4px 0;
            margin-bottom: 1.2em;
            font-style: italic;
        }
        
        /* Table of contents styling */
        #toc {
            background-color: #f8fafd !important;
            border: 1px solid #dce3f0 !important;
            border-radius: 6px !important;
            padding: 1em !important;
            margin: 1.5em 0 1.5em 1.5em !important;
            max-width: 300px !important;
            font-size: 0.9rem !important;
        }
        
        #toc-list {
            margin-bottom: 0 !important;
        }
        
        #toc-list li {
            margin-bottom: 0.5em !important;
        }
        
        #toc-list a {
            color: #14418B !important;
            text-decoration: none !important;
        }
        
        #toc-list a:hover {
            text-decoration: underline !important;
        }
        
        /* Preview mode styling */
        .preview-mode {
            background-color: #fff !important;
            padding: 30px !important;
            border-radius: 8px !important;
            border: 1px solid #eee !important;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05) !important;
            font-family: 'Raleway', sans-serif !important;
            line-height: 1.6 !important;
            max-width: 100% !important;
            margin: 0 auto !important;
        }
        
        .preview-mode h1, .preview-mode h2, .preview-mode h3 {
            color: #14418B !important;
            margin-top: 1.8em !important;
            margin-bottom: 0.8em !important;
        }
        
        .preview-mode p {
            margin-bottom: 1.2em !important;
        }
        
        /* Sidebar TOC styling */
        .sidebar-toc {
            position: fixed !important;
            top: 120px !important;
            left: 20px !important;
            width: 250px !important;
            max-height: 70vh !important;
            overflow-y: auto !important;
            background-color: #f8fafd !important;
            border: 1px solid #dce3f0 !important;
            border-radius: 6px !important;
            padding: 1em !important;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05) !important;
            z-index: 100 !important;
        }
        
        /* Add keyboard shortcut hints */
        .editor-toolbar button:after {
            content: attr(data-shortcut);
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #888;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .editor-toolbar button:hover:after {
            opacity: 1;
        }
        
        /* Override any problematic global button styles */
        #refresh-btn, #folder-actions-btn, #new-file-btn, #new-folder-btn {
            display: block !important;
            width: 100% !important;
            text-align: left !important;
            font-size: 13px !important;
            padding: 8px 12px !important;
            border-radius: 4px !important;
            border: 1px solid #ccc !important;
            background-color: #f8f8f8 !important;
            cursor: pointer !important;
            margin: 0 !important;
            height: auto !important;
            min-height: 0 !important;
            max-height: none !important;
            box-sizing: border-box !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            line-height: normal !important;
            color: #444 !important;
            white-space: nowrap !important;
            overflow: visible !important;
            box-shadow: none !important;
            position: static !important;
            float: none !important;
            clear: both !important;
        }
        
        /* Make sure icons are visible */
        #refresh-btn i, #folder-actions-btn i, #new-file-btn i, #new-folder-btn i {
            display: inline-block !important;
            margin-right: 8px !important;
            width: auto !important;
            text-align: center !important;
            font-size: inherit !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        :root {
            /* Color variables */
            --sidebar-bg: #f9f9f9;
            --content-bg: #ffffff;
            --metadata-bg: #fafafa;
            --border-color: #eee;
            --highlight-color: #14418B;
            --light-highlight: #e0e9ff;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
        }
        
        body {
            font-family: 'Raleway', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            background-color: #f5f5f5;
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
        }
        
        /* Corner decorative elements */
        body::before,
        body::after {
            content: "";
            position: fixed;
            width: 200px;
            height: 200px;
            opacity: 0.1;
            z-index: -1;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpolygon points='50,0 100,25 100,75 50,100 0,75 0,25' fill='%2314418B'/%3E%3Cpolygon points='50,20 80,35 80,65 50,80 20,65 20,35' fill='none' stroke='%2314418B' stroke-width='0.5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
        }
        
        body::before {
            top: 0;
            left: 0;
            transform: rotate(-30deg);
        }
        
        body::after {
            bottom: 0;
            right: 0;
            transform: rotate(30deg);
        }
        
        header {
            background-color: #14418B;
            background-image: linear-gradient(to right, #0a2859, #14418B, #2e5cb8);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        /* Orbital decoration */
        header::after {
            content: "";
            position: absolute;
            top: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            z-index: 0;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }
        
        h1 {
            margin: 0;
            font-size: 2.5rem;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            font-weight: 300;
            opacity: 0.9;
            margin-top: 0.7rem;
            position: relative;
            z-index: 1;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        /* Core Layout System */
        * {
            box-sizing: border-box;
        }
        
        /* Main container styles */
        .container {
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 0 1.5rem;
            display: flex;
            gap: 20px;
            min-height: 0;
            flex-wrap: nowrap;
            width: 100%;
        }
        
        /* Sidebar styles */
        .sidebar {
            width: 300px;
            min-width: 300px;
            max-width: 300px;
            flex: 0 0 300px;
            background-color: var(--sidebar-bg);
            border-radius: 12px;
            padding: var(--spacing-lg);
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: width 0.3s ease, transform 0.3s ease;
        }
        
        .sidebar::before {
            content: "";
            position: absolute;
            height: 6px;
            left: 0;
            right: 0;
            top: 0;
            background: linear-gradient(to right, #0a2859, var(--highlight-color));
            opacity: 0.7;
        }
        
        /* Sidebar toggle */
        #sidebar-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
            z-index: 10;
        }
        
        #sidebar-toggle:hover {
            opacity: 1;
        }
        
        /* Collapsed sidebar */
        .sidebar.collapsed {
            width: 50px;
            padding: var(--spacing-md) 10px;
        }
        
        .sidebar.collapsed .sidebar-content {
            display: none;
        }
        
        .sidebar.collapsed #sidebar-toggle {
            transform: rotate(180deg);
        }
        
        /* Content area styles */
        .content {
            flex: 1;
            min-width: 0; /* Prevents content from overflowing flex container */
            background-color: var(--content-bg);
            border-radius: 12px;
            padding: var(--spacing-lg);
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: auto;
            transition: padding 0.3s ease;
        }
        
        .content::before {
            content: "";
            position: absolute;
            height: 6px;
            left: 0;
            right: 0;
            top: 0;
            background: linear-gradient(to right, #0a2859, var(--highlight-color));
            opacity: 0.7;
        }
        
        /* View modes */
        body.compact-mode .content {
            padding: var(--spacing-sm);
        }
        
        body.compact-mode .sidebar {
            padding: var(--spacing-sm);
        }
        
        body.compact-mode .file-item {
            padding: 6px 10px;
        }
        
        body.reading-mode .sidebar {
            display: none;
        }
        
        body.reading-mode .content {
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.1em;
            line-height: 1.8;
        }
        
        /* Form elements */
        select, button, input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Raleway', sans-serif;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #14418B;
            box-shadow: 0 0 0 3px rgba(20, 65, 139, 0.1);
        }
        
        button {
            background-color: #14418B;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(20, 65, 139, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            background-color: #1a52ad;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(20, 65, 139, 0.25);
        }
        
        /* File list styles */
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: var(--spacing-md);
            background-color: white;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.02);
            position: relative;
        }
        
        .file-item {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .file-item:hover {
            background-color: var(--light-highlight);
        }
        
        .file-item.active {
            background-color: #f8faff;
            padding-left: calc(var(--spacing-md) - 5px);
        }
        
        /* Left highlight bar for active item */
        .file-item.active::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background-color: var(--highlight-color);
        }
        
        /* File preview tooltip */
        .file-item .preview-tooltip {
            position: absolute;
            z-index: 100;
            width: 250px;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: var(--spacing-sm);
            font-size: 12px;
            color: var(--text-secondary);
            display: none;
            top: 0;
            left: calc(100% + 10px);
            max-height: 100px;
            overflow: hidden;
        }
        
        .file-item:hover .preview-tooltip {
            display: block;
        }
        
        /* Content display */
        .content-display {
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #eee;
            max-height: 600px;
            overflow: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            margin-top: 20px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.03);
        }
        
        /* Logs section */
        .logs {
            margin-top: 20px;
            max-height: 170px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #eee;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #555;
        }
        
        .log-entry {
            border-bottom: 1px solid #eee;
            padding: 4px 0;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        .action-button-secondary {
            background-color: #e0e0e0 !important;
            color: #333 !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05) !important;
        }
        
        .action-button-secondary:hover {
            background-color: #d0d0d0 !important;
        }
        
        .action-button-danger {
            background-color: #cc3333 !important;
            box-shadow: 0 4px 12px rgba(204, 51, 51, 0.15) !important;
        }
        
        .action-button-danger:hover {
            background-color: #b02e2e !important;
        }
        
        /* Search / filter controls */
        .search-controls {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-controls input {
            padding-left: 35px;
            margin-bottom: 5px;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 12px;
            color: #aaa;
        }
        
        /* Footer */
        footer {
            background: linear-gradient(to right, #0a2859, #14418B, #2e5cb8);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 -3px 10px rgba(0,0,0,0.07);
        }
        
        footer::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Ccircle cx='10' cy='10' r='0.5' fill='%23ffffff' fill-opacity='0.1'/%3E%3C/svg%3E");
            opacity: 0.3;
        }
        
        footer p {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            font-weight: 400;
            letter-spacing: 1px;
            position: relative;
            z-index: 1;
        }
        
        /* Tool toggles */
        .tools-toggle {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        /* Tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 15px;
        }
        
        .tag {
            background-color: #e8f0ff;
            color: #14418B;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(20, 65, 139, 0.1);
        }
        
        .tag:hover {
            background-color: #d0e0ff;
        }
        
        .tag.active {
            background-color: #14418B;
            color: white;
            border-color: #14418B;
        }
        
        .tag.active:hover {
            background-color: #0a2859;
        }
        
        .tag i {
            margin-left: 5px;
            font-size: 0.75rem;
        }
        
        /* Responsive design */
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
                gap: 15px;
            }
            
            .sidebar {
                width: 100%;
                max-width: none;
                min-width: 0;
                flex: 0 0 auto;
                margin-bottom: 15px;
            }
            
            .content {
                width: 100%;
            }
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 0 1rem;
                margin: 1rem auto;
                gap: 10px;
            }
            
            .sidebar, .content {
                padding: var(--spacing-md);
                border-radius: 8px;
            }
            
            .wiki-tabs {
                flex-wrap: wrap;
            }
            
            .edit-actions {
                flex-wrap: wrap;
            }
        }
    </style>
    <style>
/* Content Display Styling */
.content-display {
    line-height: 1.6;
    overflow-wrap: break-word;
    min-height: 300px;
    background-color: #f9f9f9;
    padding: 25px;
    border-radius: 8px;
    border: 1px solid #eee;
    margin-top: 15px;
    display: block;
    position: relative;
}

.content-placeholder {
    text-align: center;
    padding: 20px;
    color: #666;
}

.content-placeholder p {
    font-size: 16px;
}

.content-placeholder .content-tip {
    margin-top: 15px;
    font-size: 13px;
}

/* Enhanced Edit Tools - Clean Implementation */
.action-button {
    font-size: 14px;
    font-weight: 500;
    padding: 8px 14px;
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 4px;
    color: #444;
    margin-right: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.action-button:hover {
    background-color: #f0f0f0;
    border-color: #ccc;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

/* Primary action buttons */
.action-button.primary, 
#save-btn, 
.action-button[id*="save"] {
    background-color: #14418B;
    color: white;
    border-color: #0a2859;
    font-weight: 600;
}

.action-button.primary:hover, 
#save-btn:hover, 
.action-button[id*="save"]:hover {
    background-color: #0a2859;
}

/* Wiki tabs with better visibility */
.wiki-tab {
    font-size: 14px;
    padding: 7px 15px;
    margin-right: 4px;
    color: #666;
    cursor: pointer;
    border-radius: 4px 4px 0 0;
    background-color: #f5f5f5;
    border: 1px solid #ddd;
    border-bottom: none;
}

.wiki-tab.active {
    background-color: white;
    color: #14418B;
    font-weight: 600;
    border-bottom: 3px solid #14418B;
}

.wiki-tab:hover {
    background-color: #f0f0f0;
}
</style>
</head>
<body>
    <header>
        <h1>Veritable Games</h1>
        <p class="subtitle">Wiki Entries & Journals</p>
    </header>

    <div class="container">
        <div class="sidebar">
            <!-- Sidebar toggle button -->
            <button id="sidebar-toggle" title="Toggle sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <div class="sidebar-content">
                <h2 style="margin-top: 0; margin-bottom: var(--spacing-md); font-size: 22px;">Notebook Explorer</h2>
            
            <!-- Unified search controls with scope toggle -->
            <div class="search-controls" style="margin-bottom: 15px; position: relative;">
                <i class="fas fa-search search-icon" style="position: absolute; left: 10px; top: 8px; color: #888;"></i>
                <input type="text" id="unified-search" placeholder="Search notebooks..." style="width: 100%; padding: 8px 8px 8px 30px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; height: 34px;">
                <div style="display: flex; margin-top: 8px; justify-content: flex-end;">
                    <div class="search-scope-toggle" style="display: inline-flex; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                        <button id="search-scope-all" class="search-scope-btn active" style="background-color: #14418B; color: white; padding: 3px 8px; font-size: 12px; border: none; margin: 0; flex: 1; cursor: pointer;">All</button>
                        <button id="search-scope-current" class="search-scope-btn" style="background-color: #f5f5f5; color: #666; padding: 3px 8px; font-size: 12px; border: none; margin: 0; flex: 1; cursor: pointer;">Current Dir</button>
                    </div>
                </div>
            </div>
            
            <!-- Directory selector with better spacing -->
            <div style="position: relative; margin-bottom: 15px;">
                <label for="directory-select" style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; color: #444;">Select Category:</label>
                <div style="position: relative;">
                    <select id="directory-select" style="width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; height: 34px; background-color: white; -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 30px;">
                        <option value="">Loading directories...</option>
                    </select>
                    <i class="fas fa-chevron-down" style="position: absolute; right: 10px; top: 11px; color: #888; pointer-events: none;"></i>
                </div>
            </div>
            
            <!-- File filter - removed in favor of unified search -->
            
            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #444;">Files:</label>
            <div class="file-list" id="file-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px;"></div>
            
            <!-- Action controls with redesigned buttons -->
            <div style="margin-bottom: 20px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="width: 100%; padding-bottom: 8px; vertical-align: top;">
                            <button id="refresh-btn" style="display: block; width: 100%; text-align: left; font-size: 13px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; background-color: #f8f8f8; cursor: pointer;">
                                <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>Refresh
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 100%; padding-bottom: 8px; vertical-align: top;">
                            <div class="dropdown" style="position: relative; width: 100%;">
                                <button id="folder-actions-btn" style="display: block; width: 100%; text-align: left; font-size: 13px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; background-color: #f8f8f8; cursor: pointer;">
                                    <i class="fas fa-cog" style="margin-right: 8px;"></i>Folder Actions
                                </button>
                                <div id="folder-dropdown-content" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: white; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 2; border: 1px solid #ddd; border-radius: 4px; margin-top: 2px;">
                                    <a id="rename-folder-btn" style="color: #333; padding: 8px 12px; text-decoration: none; display: block; cursor: pointer; font-size: 13px;">
                                        <i class="fas fa-tag" style="margin-right: 8px;"></i>Rename Folder
                                    </a>
                                    <hr style="margin: 3px 0; border-color: #eee;">
                                    <a id="delete-folder-btn" style="color: #cc3333; padding: 8px 12px; text-decoration: none; display: block; cursor: pointer; font-size: 13px;">
                                        <i class="fas fa-trash" style="margin-right: 8px;"></i>Delete Folder
                                    </a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 100%; padding-bottom: 8px; vertical-align: top;">
                            <button id="new-file-btn" style="display: block; width: 100%; text-align: left; font-size: 13px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; background-color: #f8f8f8; cursor: pointer;">
                                <i class="fas fa-file" style="margin-right: 8px;"></i>New File
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td style="width: 100%; vertical-align: top;">
                            <button id="new-folder-btn" style="display: block; width: 100%; text-align: left; font-size: 13px; padding: 8px 12px; border-radius: 4px; border: 1px solid #ccc; background-color: #f8f8f8; cursor: pointer;">
                                <i class="fas fa-folder-plus" style="margin-right: 8px;"></i>New Folder
                            </button>
                        </td>
                    </tr>
                </table>
            </div>
            
            <!-- Tags section -->
            <div class="tools-toggle" style="margin-bottom: 25px;">
                <h3 style="margin-top: 0; margin-bottom: 12px; font-size: 16px; color: #444; font-weight: 600;">Filter by Tags</h3>
                <div class="tags-container" id="tags-container" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background-color: #fafafa; min-height: 40px;">
                    <!-- Tags will be populated dynamically -->
                    <span style="color: #888; font-style: italic; font-size: 13px;">No tags available</span>
                </div>
            </div>
            
            <!-- Recent files section -->
            <div class="tools-toggle" style="margin-bottom: 25px;">
                <h3 style="margin-top: 0; margin-bottom: 12px; font-size: 16px; color: #444; font-weight: 600;">Recent Files</h3>
                <div id="recent-files" class="file-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; background-color: #fff;">
                    <!-- Recent files will be added here -->
                </div>
            </div>
            
            <!-- Log section -->
            <div style="margin-top: 20px;">
                <h3 style="margin-top: 0; margin-bottom: 12px; font-size: 16px; color: #444; font-weight: 600;">System Log</h3>
                <div class="logs" id="logs-container" style="max-height: 100px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; background-color: #f9f9f9; padding: 10px; font-family: monospace; font-size: 12px; color: #555;"></div>
            </div>
        </div>
        
        <div class="content">
            <!-- Navigation and content header -->
            <div style="margin-bottom: var(--spacing-lg);">
                <!-- Breadcrumb navigation -->
                <div class="breadcrumb-nav" style="display: flex; align-items: center; font-size: 12px; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
                    <div id="breadcrumb-path"></div>
                    
                    <!-- Navigation controls -->
                    <div style="margin-left: auto; display: flex; gap: 12px;">
                        <button id="nav-back" style="background: none; border: none; color: var(--text-secondary); opacity: 0.7; font-size: 12px; padding: 3px 6px; cursor: pointer; width: auto;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <button id="nav-forward" style="background: none; border: none; color: var(--text-secondary); opacity: 0.7; font-size: 12px; padding: 3px 6px; cursor: pointer; width: auto;">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        
                        <!-- View mode toggle -->
                        <div class="view-mode-selector" style="display: flex; border: 1px solid var(--border-color); border-radius: 3px; overflow: hidden;">
                            <button id="compact-mode-btn" title="Compact mode" style="background: none; border: none; color: var(--text-secondary); padding: 3px 6px; cursor: pointer; font-size: 12px; border-right: 1px solid var(--border-color); width: auto;">
                                <i class="fas fa-compress"></i>
                            </button>
                            <button id="normal-mode-btn" title="Normal mode" style="background-color: var(--light-highlight); border: none; color: var(--highlight-color); padding: 3px 6px; cursor: pointer; font-size: 12px; border-right: 1px solid var(--border-color); width: auto;">
                                <i class="fas fa-desktop"></i>
                            </button>
                            <button id="reading-mode-btn" title="Reading mode" style="background: none; border: none; color: var(--text-secondary); padding: 3px 6px; cursor: pointer; font-size: 12px; width: auto;">
                                <i class="fas fa-book-open"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Page title - made more prominent -->
                <h2 id="content-title" style="margin: 0 0 15px 0; font-size: 1.7rem; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #222; font-weight: 600;">
                    Select a file to view
                </h2>
                
                <!-- Streamlined minimal tabs -->
                <div class="wiki-tabs" style="display: flex; margin-bottom: 10px; gap: 0; font-size: 12px; opacity: 0.8;">
                    <div id="read-tab" class="wiki-tab active" style="padding: 4px 8px; cursor: pointer; margin-right: 1px; border-radius: 3px 3px 0 0; background-color: #f8f9fa; border: 1px solid #eee; border-bottom-color: #f8f9fa; color: #444;">
                        <i class="fas fa-book"></i> <span style="font-weight: normal;">Read</span>
                    </div>
                    <div id="edit-tab" class="wiki-tab" style="padding: 4px 8px; cursor: pointer; margin-right: 1px; border-radius: 3px 3px 0 0; background-color: #f5f5f5; border: 1px solid #eee; border-bottom-color: #eee; color: #666;">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div id="history-tab" class="wiki-tab" style="padding: 4px 8px; cursor: pointer; margin-right: 1px; border-radius: 3px 3px 0 0; background-color: #f5f5f5; border: 1px solid #eee; border-bottom-color: #eee; color: #666;">
                        <i class="fas fa-history"></i>
                    </div>
                    
                    <!-- More actions dropdown (streamlined) -->
                    <div class="dropdown" style="position: relative; display: inline-block; margin-left: 1px;">
                        <div id="more-actions-btn" style="padding: 4px 8px; cursor: pointer; border-radius: 3px 3px 0 0; background-color: #f5f5f5; border: 1px solid #eee; color: #666;">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div id="dropdown-content" style="display: none; position: absolute; right: 0; background-color: white; min-width: 140px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 100; border: 1px solid #eee; border-radius: 0 0 3px 3px; font-size: 11px;">
                            <a id="rename-btn" style="color: #555; padding: 8px 12px; text-decoration: none; display: block; cursor: pointer;">
                                <i class="fas fa-tag" style="width: 12px; margin-right: 8px; color: #888;"></i>Rename
                            </a>
                            <a id="move-btn" style="color: #555; padding: 8px 12px; text-decoration: none; display: block; cursor: pointer;">
                                <i class="fas fa-folder-open" style="width: 12px; margin-right: 8px; color: #888;"></i>Move
                            </a>
                            <a id="whatlinks-btn" style="color: #555; padding: 8px 12px; text-decoration: none; display: block; cursor: pointer;">
                                <i class="fas fa-link" style="width: 12px; margin-right: 8px; color: #888;"></i>References
                            </a>
                            <hr style="margin: 2px 0; border-color: #f5f5f5;">
                            <a id="delete-btn" style="color: #cc3333; padding: 8px 12px; text-decoration: none; display: block; cursor: pointer; opacity: 0.8;">
                                <i class="fas fa-trash" style="width: 12px; margin-right: 8px; opacity: 0.8;"></i>Delete
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- File tags - minimal style -->
            <div id="file-tags" class="tags-container" style="display: none; margin-bottom: 15px; padding: 4px 0; border-bottom: 1px dotted #f0f0f0; font-size: 11px;">
                <i class="fas fa-tags" style="color: #aaa; margin-right: 6px; font-size: 10px;"></i>
                <span class="tag" style="background-color: transparent; border: 1px dotted #ddd; color: #888; padding: 2px 6px; border-radius: 2px; font-size: 10px;">Add tags <i class="fas fa-plus" style="font-size: 8px;"></i></span>
            </div>
            
            <!-- Content view (Read mode) -->
            <div id="read-view">
                <!-- Toggle mode buttons - minimal style -->
                <div id="view-mode-controls" style="display: none; margin-bottom: 15px; text-align: right; opacity: 0.8;">
                    <button id="toggle-toc-btn" class="action-button-secondary" style="margin-right: 5px; padding: 4px 8px; border: 1px solid #eee; border-radius: 3px; background-color: #f9f9f9; cursor: pointer; font-size: 11px; color: #777;">
                        <i class="fas fa-list" style="font-size: 10px;"></i> TOC
                    </button>
                    <button id="toggle-preview-btn" class="action-button-secondary" style="padding: 4px 8px; border: 1px solid #eee; border-radius: 3px; background-color: #f9f9f9; cursor: pointer; font-size: 11px; color: #777;">
                        <i class="fas fa-eye" style="font-size: 10px;"></i> Preview
                    </button>
                </div>
                
                <!-- Minimal info text -->
                <div id="info-box" style="display: none; border-top: 1px dotted #eee; padding: 8px 0; margin-bottom: 15px; font-size: 10px; color: #999;">
                    <div id="info-content" style="display: flex; gap: 12px;">
                        <div>Created: <span id="create-date">Unknown</span></div>
                        <div>Modified: <span id="modified-date">Unknown</span></div>
                        <div>Size: <span id="content-size">0</span> bytes</div>
                    </div>
                </div>
                
                <!-- Table of contents - more subtle styling -->
                <div id="toc" style="display: none; border: 1px solid #eee; background-color: #fafafa; padding: 12px; font-size: 11px; float: right; margin: 0 0 12px 15px; max-width: 250px; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.03);">
                    <div style="font-weight: 500; border-bottom: 1px solid #eee; padding-bottom: 6px; margin-bottom: 8px; color: #666; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">
                        Contents
                    </div>
                    <ol id="toc-list" style="margin: 0; padding-left: 16px; color: #777;"></ol>
                </div>
                
                <!-- Main content area -->
                <div class="content-display wiki-content" id="content-display">
                    <div class="content-placeholder">
                        <p>File content will appear here...</p>
                        <p class="content-tip">Select a file from the sidebar to view its contents.</p>
                    </div>
                </div>
                
                <!-- Content metadata - bottom of page -->
                <div id="content-meta" style="display: none; margin-top: 30px; padding-top: 10px; border-top: 1px solid #ddd; color: #666; font-size: 0.85rem;">
                    <div id="content-stats">
                        <i class="fas fa-chart-bar" style="margin-right: 5px;"></i>
                        <span id="word-count">0</span> words | 
                        <span id="line-count">0</span> lines | 
                        <span id="reading-time">0</span> min read
                    </div>
                    
                    <!-- Wiki navigation footer -->
                    <div style="margin-top: 10px; display: flex;">
                        <div style="flex: 1;">
                            <i class="fas fa-folder" style="margin-right: 5px;"></i>
                            Category: <span id="category-name"></span>
                        </div>
                        <div>
                            <i class="fas fa-external-link-alt" style="margin-right: 5px;"></i>
                            <a href="#" id="view-raw-link" style="color: #14418B; text-decoration: none;">View raw</a> |
                            <a href="#" id="view-3d-link" style="color: #14418B; text-decoration: none;">View in 3D</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Edit view -->
            <div id="edit-view" style="display: none;">
                <!-- Minimalist edit notice -->
                <div style="border-bottom: 1px solid #f0f0f0; padding: 8px 2px; margin-bottom: 15px; color: #888; font-size: 11px;">
                    <span id="editing-filename" style="color: #666; font-weight: 500;"></span>
                    <a href="#" id="formatting-help" style="color: #888; float: right; text-decoration: none; font-size: 11px;"><i class="fas fa-question-circle" style="margin-right: 3px;"></i>Formatting</a>
                </div>
                
                <!-- Editor container with fixed toolbar -->
                <div id="editor-container" style="position: relative; border: 1px solid #ddd; border-radius: 3px; min-height: 400px; margin-bottom: 15px; margin-top: 20px; display: flex; flex-direction: column;">
                    <!-- Fixed toolbar - more compact version -->
                    <div class="editor-toolbar" style="position: static; z-index: 100; padding: 6px 8px; background-color: #f9f9f9; border-bottom: 1px solid #eee; border-top-left-radius: 3px; border-top-right-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); display: flex; flex-wrap: wrap; align-items: center; transition: all 0.3s ease; opacity: 0.9; font-size: 12px;">
                        <!-- Button group 1: Text formatting -->
                        <div style="display: flex; margin-right: 8px;">
                            <button class="toolbar-btn" data-format="bold" title="Bold (Ctrl+B)" style="background-color: #ffffff; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #555; min-width: 26px; box-shadow: none; font-size: 11px;">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button class="toolbar-btn" data-format="italic" title="Italic (Ctrl+I)" style="background-color: #ffffff; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #555; min-width: 26px; font-size: 11px; box-shadow: none;">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button class="toolbar-btn" data-format="heading" title="Heading" style="background-color: #ffffff; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #555; min-width: 26px; font-size: 11px; box-shadow: none;">
                                <i class="fas fa-heading"></i>
                            </button>
                        </div>
                        
                        <span style="display: inline-block; width: 1px; height: 18px; background: #ddd; margin: 0 4px;"></span>
                        
                        <!-- Button group 2: Lists -->
                        <div style="display: flex; margin-right: 8px;">
                            <button class="toolbar-btn" data-format="list-ul" title="Bulleted List" style="background-color: #ffffff; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #555; min-width: 26px; font-size: 11px; box-shadow: none;">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button class="toolbar-btn" data-format="list-ol" title="Numbered List" style="background-color: #ffffff; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #555; min-width: 26px; font-size: 11px; box-shadow: none;">
                                <i class="fas fa-list-ol"></i>
                            </button>
                        </div>
                        
                        <span style="display: inline-block; width: 1px; height: 18px; background: #ddd; margin: 0 4px;"></span>
                        
                        <!-- Button group 3: Insert -->
                        <div style="display: flex; margin-right: 8px;">
                            <button class="toolbar-btn" data-format="link" title="Link (Ctrl+K)" style="background-color: #ffffff; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #555; min-width: 26px; font-size: 11px; box-shadow: none;">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="toolbar-btn" data-format="image" title="Image" style="background-color: #ffffff; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #555; min-width: 26px; font-size: 11px; box-shadow: none;">
                                <i class="fas fa-image"></i>
                            </button>
                            <button class="toolbar-btn" data-format="code" title="Code Block" style="background-color: #ffffff; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #555; min-width: 26px; font-size: 11px; box-shadow: none;">
                                <i class="fas fa-code"></i>
                            </button>
                        </div>
                        
                        <span style="display: inline-block; width: 1px; height: 18px; background: #ddd; margin: 0 4px;"></span>
                        
                        <!-- Button group 4: Clear formatting -->
                        <div style="display: flex; margin-right: auto;">
                            <button class="toolbar-btn" data-format="clear-format" title="Clear Formatting" style="background-color: #ffffff; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #555; min-width: 26px; font-size: 11px; box-shadow: none;">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                        
                        <!-- Toggle button - more subtle style -->
                        <button id="toolbar-toggle" title="Toggle Toolbar" style="background-color: #f8f8f8; border: 1px solid #ddd; margin: 1px; padding: 4px 6px; border-radius: 2px; cursor: pointer; color: #888; min-width: 26px; font-size: 11px; box-shadow: none; position: relative; z-index: 101;">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    
                    <!-- Editor textarea without extra top padding since toolbar is now static -->
                    <textarea id="content-editor" style="width: 100%; min-height: 400px; font-family: 'Courier New', monospace; line-height: 1.5; padding: 15px; font-size: 14px; resize: vertical; border: none; outline: none; flex-grow: 1;"></textarea>
                </div>
                
                <!-- Edit summary - minimal style -->
                <div style="margin-top: 12px; margin-bottom: 12px;">
                    <input type="text" id="edit-summary" style="width: 100%; padding: 6px; border: 1px solid #eee; border-radius: 3px; font-size: 12px;" placeholder="Edit summary (optional)">
                </div>
                
                <!-- Edit actions - wiki style placement at bottom -->
                <div class="edit-actions" style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label style="font-size: 11px; color: #777;">
                                <input type="checkbox" id="minor-edit" style="margin-right: 3px;"> Minor edit
                            </label>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button id="preview-btn" style="background-color: #f8f9fa; color: #666; border: 1px solid #eee; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button id="cancel-edit-btn" style="background-color: #f8f9fa; color: #666; border: 1px solid #eee; padding: 6px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-times"></i>
                            </button>
                            <button id="save-btn" style="background-color: #f0f7ff; color: #14418B; border: 1px solid #d0e0f7; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-check"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- History view - Wiki style -->
            <div id="history-view" style="display: none;">
                <!-- History intro text -->
                <div style="background-color: #f8f9fa; border: 1px solid #eaecf0; padding: 10px; margin-bottom: 15px; color: #555; font-size: 0.9rem; border-radius: 3px;">
                    <i class="fas fa-info-circle" style="color: #14418B; margin-right: 5px;"></i>
                    This page shows the revision history for <strong id="history-filename"></strong>. Click on a date to view that version.
                </div>
                
                <!-- History controls -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <label style="font-size: 0.9rem; margin-right: 10px;">
                                <input type="checkbox" id="show-minor-edits" checked style="margin-right: 5px;"> Show minor edits
                            </label>
                        </div>
                        <div>
                            <button id="compare-btn" style="background-color: #f5f5f5; color: #333; border: 1px solid #ddd; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 0.9rem;">
                                <i class="fas fa-exchange-alt"></i> Compare selected versions
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Version list - will be populated dynamically -->
                <div id="version-list">
                    <!-- Versions will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Veritable Games &copy; 2025 | Data Navigation Reimagined</p>
    </footer>
    

    <script>
        // Function to initialize view mode toggles
        function initializeViewModeToggles() {
            // TOC toggle button
            const toggleTocBtn = document.getElementById('toggle-toc-btn');
            if (toggleTocBtn) {
                toggleTocBtn.addEventListener('click', () => {
                    const toc = document.getElementById('toc');
                    if (toc) {
                        // Toggle TOC visibility
                        if (toc.style.display === 'none') {
                            toc.style.display = 'block';
                            toggleTocBtn.innerHTML = '<i class="fas fa-list"></i> Hide TOC';
                        } else {
                            toc.style.display = 'none';
                            toggleTocBtn.innerHTML = '<i class="fas fa-list"></i> Show TOC';
                        }
                    }
                    log('TOC visibility toggled');
                });
            }
            
            // Preview mode toggle button
            const togglePreviewBtn = document.getElementById('toggle-preview-btn');
            if (togglePreviewBtn) {
                togglePreviewBtn.addEventListener('click', () => {
                    const contentDisplay = document.getElementById('content-display');
                    
                    if (contentDisplay) {
                        // Toggle between edit and preview modes
                        if (contentDisplay.classList.contains('preview-mode')) {
                            // Switch back to edit mode
                            contentDisplay.classList.remove('preview-mode');
                            togglePreviewBtn.innerHTML = '<i class="fas fa-eye"></i> Preview Mode';
                            // Show editor controls if they exist
                            const editorControls = document.querySelector('.editor-toolbar');
                            if (editorControls) editorControls.style.display = 'block';
                        } else {
                            // Switch to preview mode
                            contentDisplay.classList.add('preview-mode');
                            togglePreviewBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Mode';
                            // Hide editor controls if they exist
                            const editorControls = document.querySelector('.editor-toolbar');
                            if (editorControls) editorControls.style.display = 'none';
                        }
                        log('Preview mode toggled');
                    }
                });
            }
        }
        
        // Configuration
        const API_BASE_URL = 'http://localhost:3003';
        const logsContainer = document.getElementById('logs-container');
        const directorySelect = document.getElementById('directory-select');
        const fileList = document.getElementById('file-list');
        const contentTitle = document.getElementById('content-title');
        const contentDisplay = document.getElementById('content-display');
        const refreshBtn = document.getElementById('refresh-btn');
        const newFileBtn = document.getElementById('new-file-btn');
        const newFolderBtn = document.getElementById('new-folder-btn');
        const unifiedSearch = document.getElementById('unified-search');
        const fileTags = document.getElementById('file-tags');
        const saveBtn = document.getElementById('save-btn');
        const renameBtn = document.getElementById('rename-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const contentEditor = document.getElementById('content-editor');
        
        // Tab elements
        const readTab = document.getElementById('read-tab');
        const editTab = document.getElementById('edit-tab');
        const historyTab = document.getElementById('history-tab');
        const readView = document.getElementById('read-view');
        const editView = document.getElementById('edit-view');
        const historyView = document.getElementById('history-view');
        
        // Current state
        let currentDirectory = '';
        let currentFile = '';
        let currentView = 'read'; // 'read', 'edit', or 'history'
        
        // Recent files tracking
        const MAX_RECENT_FILES = 5;
        let recentFiles = JSON.parse(localStorage.getItem('recentFiles') || '[]');
        
        // File version history
        let fileVersions = [];
        
        // Log function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `[${timestamp}] <span style="color: #14418B;">${message}</span>`;
            logsContainer.appendChild(logEntry);
            
            // Keep only last 20 logs
            while (logsContainer.childNodes.length > 20) {
                logsContainer.removeChild(logsContainer.firstChild);
            }
            
            // Scroll to bottom
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        // Extract URL parameters
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pairs = queryString.split('&');
            
            for (const pair of pairs) {
                const [key, value] = pair.split('=');
                if (key && value) {
                    params[decodeURIComponent(key)] = decodeURIComponent(value);
                }
            }
            
            return params;
        }
        
        // Fetch notebook directories
        function fetchNotebookDirectories() {
            log('Fetching notebook directories...');
            fetch(`${API_BASE_URL}/notebooks`)
                .then(response => response.json())
                .then(data => {
                    // Get any locally stored folders
                    const localFolders = JSON.parse(localStorage.getItem('local_folders') || '[]');
                    
                    // Combine API folders with local folders (removing duplicates)
                    let allDirectories = data.directories || [];
                    
                    // Add local folders that aren't already in the API response
                    localFolders.forEach(folder => {
                        if (!allDirectories.includes(folder)) {
                            allDirectories.push(folder);
                        }
                    });
                    
                    log(`Found ${allDirectories.length} directories (including local folders)`);
                    directorySelect.innerHTML = '<option value="">Select a directory</option>';
                    
                    if (allDirectories.length > 0) {
                        // Sort directories alphabetically
                        allDirectories.sort();
                        
                        allDirectories.forEach(dir => {
                            const option = document.createElement('option');
                            option.value = dir;
                            
                            // Mark local-only folders in the UI
                            if (localFolders.includes(dir) && !data.directories.includes(dir)) {
                                option.textContent = `${dir} (local)`;
                                option.style.fontStyle = 'italic';
                                option.style.color = '#14418B';
                            } else {
                                option.textContent = dir;
                            }
                            
                            directorySelect.appendChild(option);
                        });
                        
                        // Check for URL parameters for auto-loading
                        const params = getUrlParams();
                        if (params.category) {
                            // Find closest matching directory
                            const matchingDir = findMatchingDirectory(params.category, allDirectories);
                            if (matchingDir) {
                                directorySelect.value = matchingDir;
                                fetchNotebookFiles(matchingDir, params.file);
                            }
                        }
                    }
                })
                .catch(error => {
                    log(`Error fetching directories from API: ${error.message}`);
                    
                    // Still load local folders if API fails
                    const localFolders = JSON.parse(localStorage.getItem('local_folders') || '[]');
                    
                    if (localFolders.length > 0) {
                        log(`Found ${localFolders.length} local directories`);
                        directorySelect.innerHTML = '<option value="">Select a directory</option>';
                        
                        localFolders.sort().forEach(dir => {
                            const option = document.createElement('option');
                            option.value = dir;
                            option.textContent = `${dir} (local)`;
                            option.style.fontStyle = 'italic';
                            option.style.color = '#14418B';
                            directorySelect.appendChild(option);
                        });
                    } else {
                        directorySelect.innerHTML = '<option value="">Error loading directories</option>';
                    }
                });
        }
        
        // Find closest matching directory based on slug
        function findMatchingDirectory(slug, directories) {
            // Try direct match first
            const directMatch = directories.find(dir => 
                dir.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') === slug
            );
            
            if (directMatch) return directMatch;
            
            // Try fuzzy match
            const normalizedSlug = slug.toLowerCase();
            return directories.find(dir => dir.toLowerCase().includes(normalizedSlug));
        }
        
        // Fetch files in a directory
        function fetchNotebookFiles(directory, targetFile = null) {
            log(`Fetching files for directory: ${directory}`);
            fileList.innerHTML = 'Loading...';
            currentDirectory = directory;
            
            // Update unified search to show we're in directory mode
            const scopeCurrentBtn = document.getElementById('search-scope-current');
            const scopeAllBtn = document.getElementById('search-scope-all');
            const unifiedSearch = document.getElementById('unified-search');
            
            if (scopeCurrentBtn && unifiedSearch) {
                // Reset any active search/filter
                unifiedSearch.value = '';
                
                // Set "Current Dir" as active by default when a directory is selected
                scopeCurrentBtn.classList.add('active');
                scopeCurrentBtn.style.backgroundColor = '#14418B';
                scopeCurrentBtn.style.color = 'white';
                scopeAllBtn.classList.remove('active');
                scopeAllBtn.style.backgroundColor = '#f5f5f5';
                scopeAllBtn.style.color = '#666';
                unifiedSearch.placeholder = 'Filter current directory...';
            }
            
            // Find all locally stored files for this directory
            function getLocalFiles(directory) {
                const localFiles = [];
                // Loop through all localStorage items
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Look for content keys that match this directory
                    if (key && key.startsWith(`content_${directory}_`)) {
                        // Extract the filename from the key
                        const filename = key.replace(`content_${directory}_`, '');
                        if (filename && !localFiles.includes(filename)) {
                            localFiles.push(filename);
                        }
                    }
                }
                return localFiles;
            }
            
            fetch(`${API_BASE_URL}/notebooks/${directory}`)
                .then(response => response.json())
                .then(data => {
                    fileList.innerHTML = '';
                    
                    // Get local files for this directory
                    const localFiles = getLocalFiles(directory);
                    
                    // Combine API files with local files (removing duplicates)
                    let allFiles = data.files || [];
                    
                    // Add local files that aren't already in the API response
                    localFiles.forEach(file => {
                        if (!allFiles.includes(file)) {
                            allFiles.push(file);
                        }
                    });
                    
                    if (allFiles.length > 0) {
                        log(`Found ${allFiles.length} files (including local files)`);
                        
                        // Sort files alphabetically
                        allFiles.sort();
                        
                        const fileItems = document.createElement('div');
                        fileItems.id = 'file-items';
                        fileList.appendChild(fileItems);
                        
                        allFiles.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            
                            // Add file icon based on extension
                            let fileIcon = 'fa-file-alt';
                            if (file.endsWith('.md')) fileIcon = 'fa-file-code';
                            else if (file.endsWith('.json')) fileIcon = 'fa-file-code';
                            
                            // Mark local-only files
                            const isLocalOnly = localFiles.includes(file) && !data.files.includes(file);
                            if (isLocalOnly) {
                                fileItem.innerHTML = `<i class="far ${fileIcon}" style="margin-right: 8px; color: #14418B;"></i>${file} <span style="font-size: 0.8rem; color: #14418B; font-style: italic;">(local)</span>`;
                            } else {
                                fileItem.innerHTML = `<i class="far ${fileIcon}" style="margin-right: 8px; color: #777;"></i>${file}`;
                            }
                            
                            fileItem.setAttribute('data-filename', file.toLowerCase());
                            fileItem.addEventListener('click', () => {
                                // Clear active class from all items
                                document.querySelectorAll('.file-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                
                                // Add active class to clicked item
                                fileItem.classList.add('active');
                                
                                // Fetch file content
                                fetchNotebookContent(directory, file);
                            });
                            fileItems.appendChild(fileItem);
                            
                            // If this is the target file (from URL params), select it
                            if (targetFile && file.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') === targetFile) {
                                fileItem.click();
                            }
                        });
                    } else {
                        fileList.innerHTML = '<div class="file-item">No files found</div>';
                        log('No files found in directory');
                    }
                })
                .catch(error => {
                    log(`Error fetching from API: ${error.message}`);
                    
                    // Try to display local files if API fails
                    const localFiles = getLocalFiles(directory);
                    
                    if (localFiles.length > 0) {
                        log(`Found ${localFiles.length} local files`);
                        fileList.innerHTML = '';
                        
                        const fileItems = document.createElement('div');
                        fileItems.id = 'file-items';
                        fileList.appendChild(fileItems);
                        
                        localFiles.sort().forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            
                            // Add file icon based on extension
                            let fileIcon = 'fa-file-alt';
                            if (file.endsWith('.md')) fileIcon = 'fa-file-code';
                            else if (file.endsWith('.json')) fileIcon = 'fa-file-code';
                            
                            fileItem.innerHTML = `<i class="far ${fileIcon}" style="margin-right: 8px; color: #14418B;"></i>${file} <span style="font-size: 0.8rem; color: #14418B; font-style: italic;">(local)</span>`;
                            fileItem.setAttribute('data-filename', file.toLowerCase());
                            
                            fileItem.addEventListener('click', () => {
                                // Clear active class from all items
                                document.querySelectorAll('.file-item').forEach(item => {
                                    item.classList.remove('active');
                                });
                                
                                // Add active class to clicked item
                                fileItem.classList.add('active');
                                
                                // Fetch file content
                                fetchNotebookContent(directory, file);
                            });
                            fileItems.appendChild(fileItem);
                            
                            // If this is the target file, select it
                            if (targetFile && file.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') === targetFile) {
                                fileItem.click();
                            }
                        });
                    } else {
                        fileList.innerHTML = `<div class="file-item">Error fetching files. Try creating a new file.</div>`;
                    }
                });
        }
        
        // Add to recent files
        function addToRecentFiles(directory, file) {
            // Create a new entry
            const newEntry = {
                directory: directory,
                file: file,
                timestamp: new Date().getTime()
            };
            
            // Remove if already exists
            recentFiles = recentFiles.filter(entry => 
                !(entry.directory === directory && entry.file === file)
            );
            
            // Add to beginning
            recentFiles.unshift(newEntry);
            
            // Limit size
            if (recentFiles.length > MAX_RECENT_FILES) {
                recentFiles = recentFiles.slice(0, MAX_RECENT_FILES);
            }
            
            // Save to localStorage
            localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
            
            // Update UI
            displayRecentFiles();
        }
        
        // Display recent files
        function displayRecentFiles() {
            const recentFilesContainer = document.getElementById('recent-files');
            recentFilesContainer.innerHTML = '';
            
            if (recentFiles.length === 0) {
                recentFilesContainer.innerHTML = '<div style="padding: 10px; color: #888; font-style: italic;">No recent files</div>';
                return;
            }
            
            recentFiles.forEach(entry => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.style.padding = '8px 10px';
                fileItem.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <i class="far fa-file-alt" style="margin-right: 8px; color: #777;"></i>
                            <span style="font-size: 0.9rem;">${entry.file}</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #888; white-space: nowrap;">
                            ${formatTimestamp(entry.timestamp)}
                        </div>
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 3px;">
                        ${entry.directory}
                    </div>
                `;
                
                fileItem.addEventListener('click', () => {
                    // First select the directory
                    directorySelect.value = entry.directory;
                    
                    // Then load the files and select this file
                    fetchNotebookFiles(entry.directory, entry.file.replace(/\.(txt|md)$/, ''));
                });
                
                recentFilesContainer.appendChild(fileItem);
            });
        }
        
        // Format timestamp
        function formatTimestamp(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            
            // If today, show time
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // If yesterday, show "Yesterday"
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            }
            
            // Otherwise show date
            return date.toLocaleDateString();
        }
        
        // Fetch file content
        function fetchNotebookContent(directory, file) {
            log(`Fetching content for file: ${file}`);
            contentTitle.textContent = file;
            contentDisplay.textContent = 'Loading content...';
            currentFile = file;
            
            // Update editing filename display
            document.getElementById('editing-filename').textContent = file;
            document.getElementById('history-filename').textContent = file;
            
            // Add to recent files
            addToRecentFiles(directory, file);
            
            // Show the more actions dropdown for this file
            document.getElementById('more-actions-btn').style.display = 'block';
            
            // Show tags
            fileTags.style.display = 'flex';
            
            // Check if we have a local version of this file in localStorage
            const localContent = localStorage.getItem(`content_${directory}_${file}`);
            
            // If we have local content, use it and indicate it's a local version
            if (localContent) {
                log(`Loading content from local storage for ${file}`);
                processFileContent(localContent, true);
                return;
            }
            
            // Otherwise try to fetch from the API
            fetch(`${API_BASE_URL}/notebooks/${directory}/${file}`)
                .then(response => response.text())
                .then(content => {
                    processFileContent(content, false);
                })
                .catch(error => {
                    log(`Error from API: ${error.message}`);
                    
                    // If API fails but we have local content, use that as a fallback
                    const localContent = localStorage.getItem(`content_${directory}_${file}`);
                    if (localContent) {
                        log(`Falling back to local version of ${file}`);
                        processFileContent(localContent, true);
                    } else {
                        contentDisplay.textContent = `Error loading file: ${error.message}`;
                        
                        // Hide elements on error
                        document.getElementById('more-actions-btn').style.display = 'none';
                        document.getElementById('info-box').style.display = 'none';
                        document.getElementById('content-meta').style.display = 'none';
                        document.getElementById('toc').style.display = 'none';
                        fileTags.style.display = 'none';
                    }
                });
        }
        
        // Process file content (either from API or localStorage)
        function processFileContent(content, isLocal) {
            // Always go to read view first when loading a file
            switchView('read');
            
            contentDisplay.innerHTML = '';
            
            // Clean up Zim Wiki format headers before displaying in the editor
            let cleanContent = content;
            
            // Check if content has Zim Wiki headers
            if (content.includes('Content-Type: text/x-zim-wiki') || 
                content.includes('Wiki-Format: zim') || 
                content.includes('Creation-Date:')) {
                
                // Remove Zim Wiki headers and formatting artifacts for cleaner editing
                cleanContent = content.replace(/Content-Type: text\/x-zim-wiki\s*/g, '')
                                    .replace(/Wiki-Format: zim \d\.\d\s*/g, '')
                                    .replace(/Creation-Date: [^\n]*\s*/g, '')
                                    .replace(/\[(.*?)\]/g, '$1') // Remove square brackets but keep content
                                    .replace(/====== ([^=]+) ======/g, '# $1') // Format main headers
                                    .replace(/===== ([^=]+) =====/g, '## $1') // Format subheaders
                                    .replace(/==== ([^=]+) ====/g, '### $1') // Format sub-subheaders
                                    .replace(/\s*\d+\.\s*Item\d+\.\s*Item\d+\.\s*Item\d+\.\s*Item\d+\.\s*Item/g, '') // Remove repeated list items
                                    .replace(/\(url\)/g, '') // Remove (url) artifacts
                                    .replace(/``\d+\.\s*Item/g, '') // Remove code block + list item artifacts
                                    .trim();
                
                log('Zim Wiki format detected and cleaned for editing');
            }
            
            contentEditor.value = cleanContent;
            
            // Update page metadata and info box
            document.getElementById('info-box').style.display = 'block';
            document.getElementById('content-meta').style.display = 'block';
            
            // Set category name
            document.getElementById('category-name').textContent = currentDirectory;
            
            // Set date information 
            let modifiedDate, createDate;
            
            if (isLocal) {
                // For local files, get history from localStorage to determine dates
                const history = JSON.parse(localStorage.getItem(`history_${currentDirectory}_${currentFile}`) || '[]');
                
                if (history.length > 0) {
                    // Most recent edit is the first item
                    const latestEdit = new Date(history[0].timestamp);
                    modifiedDate = latestEdit.toLocaleDateString() + ' ' + latestEdit.toLocaleTimeString();
                    
                    // Creation date is the last item
                    const creationEdit = new Date(history[history.length - 1].timestamp);
                    createDate = creationEdit.toLocaleDateString();
                    
                    // Add a local indicator to the title
                    contentTitle.innerHTML = `${currentFile} <span style="font-size: 0.7rem; background-color: #e8f0ff; color: #14418B; padding: 2px 6px; border-radius: 10px; vertical-align: middle;">LOCAL</span>`;
                } else {
                    // If no history, use current time
                    const now = new Date();
                    modifiedDate = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                    createDate = modifiedDate;
                }
            } else {
                // For API files, use mock dates for now (could be improved if API provides this data)
                const now = new Date();
                modifiedDate = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                createDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toLocaleDateString();
            }
            
            document.getElementById('modified-date').textContent = modifiedDate;
            document.getElementById('create-date').textContent = createDate;
            document.getElementById('content-size').textContent = content.length;
            
            // Calculate content statistics
            const wordCount = content.split(/\s+/).filter(Boolean).length;
            const lineCount = content.split('\n').length;
            const readingTime = Math.ceil(wordCount / 200);
            
            document.getElementById('word-count').textContent = wordCount;
            document.getElementById('line-count').textContent = lineCount;
            document.getElementById('reading-time').textContent = readingTime;
            
            // Add event listener for the 3D view link
            document.getElementById('view-3d-link').onclick = function(e) {
                e.preventDefault();
                window.open('http://localhost:8081', '_blank');
            };
            
            // Add event listener for the raw view link
            document.getElementById('view-raw-link').onclick = function(e) {
                e.preventDefault();
                // Display raw content in a new window
                const rawWindow = window.open('', '_blank');
                rawWindow.document.write('<pre style="white-space: pre-wrap; font-family: monospace; padding: 20px;">' + 
                    content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + 
                    '</pre>');
            };
            
            // Find content keywords for tag suggestions
            const keywords = extractKeywords(content);
            updateFileTags(keywords);
            
            // Check if the file is markdown
            const isMarkdown = currentFile.toLowerCase().endsWith('.md') || 
                              currentFile.toLowerCase().endsWith('.markdown') ||
                              content.includes('# ') || 
                              content.includes('## ') ||
                              content.includes('*') ||
                              content.includes('```');
            
            if (isMarkdown) {
                // Render markdown
                contentDisplay.innerHTML = marked.parse(content);
                
                // Add wiki-content class for styling
                contentDisplay.classList.add('wiki-content');
                
                // Create table of contents if headings are present
                const headings = contentDisplay.querySelectorAll('h1, h2, h3, h4, h5, h6');
                if (headings.length > 2) {
                    const tocList = document.getElementById('toc-list');
                    tocList.innerHTML = '';
                    
                    // Create TOC title
                    const tocTitle = document.createElement('h3');
                    tocTitle.textContent = 'Table of Contents';
                    tocTitle.style.margin = '0 0 10px 0';
                    tocTitle.style.color = '#14418B';
                    tocList.appendChild(tocTitle);
                    
                    headings.forEach((heading, i) => {
                        // Add ID to the heading if it doesn't have one
                        if (!heading.id) {
                            heading.id = 'toc-heading-' + i;
                        }
                        
                        const level = parseInt(heading.tagName.substring(1)); // Get the heading level (1-6)
                        const item = document.createElement('li');
                        item.innerHTML = `<a href="#${heading.id}" style="color: #14418B; text-decoration: none;">${heading.textContent}</a>`;
                        item.style.marginLeft = (level - 1) * 15 + 'px';
                        item.style.lineHeight = '1.5';
                        item.style.marginBottom = '5px';
                        tocList.appendChild(item);
                        
                        // Add click handlers to TOC items
                        item.querySelector('a').addEventListener('click', function(e) {
                            e.preventDefault();
                            document.getElementById(heading.id).scrollIntoView({ behavior: 'smooth' });
                        });
                    });
                    
                    document.getElementById('toc').style.display = 'block';
                    document.getElementById('view-mode-controls').style.display = 'block';
                } else {
                    document.getElementById('toc').style.display = 'none';
                    // Still show view-mode-controls for preview toggle
                    document.getElementById('view-mode-controls').style.display = 'block';
                }
                
                // Show the preview mode button
                document.getElementById('toggle-preview-btn').style.display = 'inline-block';
            } else {
                document.getElementById('toc').style.display = 'none';
                document.getElementById('view-mode-controls').style.display = 'none';
                
                // Format as plain text with keyword highlighting
                const contentText = document.createElement('pre');
                const highlightedContent = highlightKeywords(content, keywords);
                contentText.innerHTML = highlightedContent;
                contentDisplay.appendChild(contentText);
            }
            
            log('Content loaded successfully' + (isLocal ? ' from local storage' : ''));
        }
        
        // Extract keywords from content
        function extractKeywords(content) {
            // Simple keyword extraction based on word frequency
            const words = content.toLowerCase().match(/\b[a-z]{4,}\b/g) || [];
            const wordCount = {};
            
            words.forEach(word => {
                if (!commonWords.includes(word)) {
                    wordCount[word] = (wordCount[word] || 0) + 1;
                }
            });
            
            // Get top 5 most frequent words
            return Object.entries(wordCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(entry => entry[0]);
        }
        
        // Common words to exclude from keyword extraction
        const commonWords = ['this', 'that', 'with', 'from', 'have', 'what', 'when', 'where', 'which', 'their', 'there', 'about'];
        
        // Update file tags based on keywords
        function updateFileTags(keywords) {
            fileTags.innerHTML = '';
            
            // Add "Add tags..." button
            const addTagSpan = document.createElement('span');
            addTagSpan.className = 'tag';
            addTagSpan.innerHTML = 'Add tags... <i class="fas fa-plus"></i>';
            addTagSpan.addEventListener('click', () => {
                const newTag = prompt('Enter a new tag:');
                if (newTag && newTag.trim() !== '') {
                    // Add the tag to the list
                    addTag(newTag.trim());
                    
                    // Save tags to the file metadata
                    saveFileTags([...document.querySelectorAll('#file-tags .tag:not(:first-child)')].map(tag => 
                        tag.textContent.trim().replace(' ', '')
                    ));
                }
            });
            fileTags.appendChild(addTagSpan);
            
            // Add keyword tags
            keywords.forEach(keyword => {
                addTag(keyword);
            });
            
            // Fetch existing tags for this file (when available)
            // For local files, we'll use locally stored tags
            const localTags = localStorage.getItem(`tags_${currentDirectory}_${currentFile}`);
            if (localTags) {
                try {
                    const tags = JSON.parse(localTags);
                    if (Array.isArray(tags)) {
                        tags.forEach(tag => {
                            // Check if this tag is already displayed
                            const existingTags = [...document.querySelectorAll('#file-tags .tag:not(:first-child)')].map(el => 
                                el.textContent.trim().replace(' ', '')
                            );
                            
                            if (!existingTags.includes(tag)) {
                                addTag(tag);
                            }
                        });
                    }
                } catch (e) {
                    log('Error parsing local tags, using keywords only');
                }
            }
            
            // Try to fetch from API as well
            fetch(`${API_BASE_URL}/notebooks/${currentDirectory}/${currentFile}/tags`)
                .then(response => {
                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        // If not JSON, handle it gracefully
                        return { tags: [] };
                    }
                })
                .then(data => {
                    if (data.tags && Array.isArray(data.tags)) {
                        // Add any tags that aren't already displayed
                        data.tags.forEach(tag => {
                            // Check if this tag is already displayed
                            const existingTags = [...document.querySelectorAll('#file-tags .tag:not(:first-child)')].map(el => 
                                el.textContent.trim().replace(' ', '')
                            );
                            
                            if (!existingTags.includes(tag)) {
                                addTag(tag);
                            }
                        });
                    }
                })
                .catch(error => {
                    // Handle error gracefully - just log to console not to the user
                    console.error('Error fetching tags from API:', error);
                });
        }
        
        // Add a single tag to the UI
        function addTag(tagText) {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'tag';
            tagSpan.innerHTML = `${tagText} <i class="fas fa-times"></i>`;
            
            // Add click handler for tag removal
            tagSpan.querySelector('i').addEventListener('click', (e) => {
                e.stopPropagation();
                tagSpan.remove();
                log(`Removed tag: ${tagText}`);
                
                // Save the updated tag list
                saveFileTags([...document.querySelectorAll('#file-tags .tag:not(:first-child)')].map(tag => 
                    tag.textContent.trim().replace(' ', '')
                ));
            });
            
            fileTags.appendChild(tagSpan);
        }
        
        // Save tags to the backend and localStorage
        function saveFileTags(tags) {
            if (!currentFile || !currentDirectory) return;
            
            // Always save to localStorage for persistence
            localStorage.setItem(`tags_${currentDirectory}_${currentFile}`, JSON.stringify(tags));
            
            // Also try to save to the backend if available
            fetch(`${API_BASE_URL}/notebooks/${currentDirectory}/${currentFile}/tags`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tags: tags })
            })
            .then(response => {
                if (response.ok) {
                    log('Tags saved successfully');
                } else {
                    // Silently save to localStorage only
                    console.log(`Backend tag save failed: ${response.statusText}, but saved locally`);
                }
            })
            .catch(error => {
                // Silently save to localStorage only - no error message to user
                console.log(`Backend tag save error: ${error.message}, but saved locally`);
            });
        }
        
        // Highlight keywords in content
        function highlightKeywords(content, keywords) {
            let highlightedContent = content;
            
            // Escape HTML special characters
            highlightedContent = highlightedContent
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Highlight keywords
            keywords.forEach(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                highlightedContent = highlightedContent.replace(
                    regex, 
                    `<span style="background-color: rgba(20, 65, 139, 0.1); border-radius: 2px; padding: 0 2px;">$&</span>`
                );
            });
            
            return highlightedContent;
        }
        
        // Add content analysis panel
        function addContentAnalysis(content) {
            // Perform a quick analysis of the content
            const wordCount = content.split(/\s+/).filter(Boolean).length;
            const lines = content.split('\n').length;
            const chars = content.length;
            
            // Calculate reading time (average reading speed is ~200-250 words per minute)
            const readingTimeMinutes = Math.ceil(wordCount / 200);
            
            // Create analysis panel
            const analysisPanel = document.createElement('div');
            analysisPanel.style.marginTop = '20px';
            analysisPanel.style.padding = '15px';
            analysisPanel.style.backgroundColor = '#f5f8ff';
            analysisPanel.style.borderRadius = '8px';
            analysisPanel.style.border = '1px solid rgba(20, 65, 139, 0.1)';
            
            analysisPanel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">Content Statistics</h3>
                    <div>
                        <button id="3d-view-btn" class="action-button-secondary" style="margin: 0; padding: 6px 12px;">
                            <i class="fas fa-cube"></i> 3D View
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; margin-top: 12px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 120px; margin-right: 15px;">
                        <div style="font-size: 0.9rem; color: #666;">Words</div>
                        <div style="font-size: 1.8rem; font-weight: 600; color: #14418B;">${wordCount}</div>
                    </div>
                    <div style="flex: 1; min-width: 120px; margin-right: 15px;">
                        <div style="font-size: 0.9rem; color: #666;">Lines</div>
                        <div style="font-size: 1.8rem; font-weight: 600; color: #14418B;">${lines}</div>
                    </div>
                    <div style="flex: 1; min-width: 120px; margin-right: 15px;">
                        <div style="font-size: 0.9rem; color: #666;">Characters</div>
                        <div style="font-size: 1.8rem; font-weight: 600; color: #14418B;">${chars}</div>
                    </div>
                    <div style="flex: 1; min-width: 120px;">
                        <div style="font-size: 0.9rem; color: #666;">Reading Time</div>
                        <div style="font-size: 1.8rem; font-weight: 600; color: #14418B;">${readingTimeMinutes} min</div>
                    </div>
                </div>
            `;
            
            contentDisplay.appendChild(analysisPanel);
            
            // Add event listener for 3D button
            document.getElementById('3d-view-btn').addEventListener('click', () => {
                window.open('http://localhost:8081', '_blank');
            });
        }
        
        // Switch view
        function switchView(view) {
            if (!currentFile && view !== 'read') {
                alert('Please select a file first');
                return;
            }
            
            currentView = view;
            
            // Update tab states with our new icon-only design for inactive tabs
            document.querySelectorAll('.wiki-tab').forEach(tab => {
                // Clear active state and reset styling
                tab.classList.remove('active');
                tab.style.fontWeight = 'normal';
                tab.style.backgroundColor = '#f5f5f5';
                tab.style.borderBottomColor = '#eee';
                tab.style.color = '#666';
                
                // Remove any text content (keep only icons for inactive tabs)
                const icon = tab.querySelector('i');
                if (icon) {
                    tab.innerHTML = '';
                    tab.appendChild(icon);
                }
            });
            
            // Style active tab
            const activeTab = document.getElementById(`${view}-tab`);
            activeTab.classList.add('active');
            activeTab.style.backgroundColor = '#f8f9fa';
            activeTab.style.borderBottomColor = '#f8f9fa';
            activeTab.style.color = '#444';
            
            // Add text to the active tab
            const icon = activeTab.querySelector('i');
            if (icon && !activeTab.querySelector('span')) {
                const iconHTML = icon.outerHTML;
                let tabText = '';
                
                // Set appropriate text based on tab
                if (view === 'read') tabText = 'Read';
                else if (view === 'edit') tabText = 'Edit';
                else if (view === 'history') tabText = 'History';
                
                activeTab.innerHTML = iconHTML + ' <span style="font-weight: normal;">' + tabText + '</span>';
            }
            
            // Hide all views
            document.getElementById('read-view').style.display = 'none';
            document.getElementById('edit-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'none';
            
            // Show selected view
            document.getElementById(`${view}-view`).style.display = 'block';
            
            // Additional setup based on view
            if (view === 'edit') {
                // Get current content, either from local storage or the editor
                let currentContent = localStorage.getItem(`content_${currentDirectory}_${currentFile}`);
                
                // If not in localStorage, get from the displayed content
                if (!currentContent && contentDisplay.textContent) {
                    currentContent = contentDisplay.textContent;
                }
                
                // Clean content of Zim Wiki format and artifacts
                if (currentContent) {
                    // Clean up Zim Wiki format headers and problematic artifacts
                    currentContent = currentContent
                        .replace(/Content-Type: text\/x-zim-wiki\s*/g, '')
                        .replace(/Wiki-Format: zim \d\.\d\s*/g, '')
                        .replace(/Creation-Date: [^\n]*\s*/g, '')
                        .replace(/\[(.*?)\]/g, '$1') // Remove square brackets
                        .replace(/\(url\)/g, '') // Remove (url) artifacts
                        .replace(/\s*\d+\.\s*Item\d+\.\s*Item\d+\.\s*Item\d+\.\s*Item\d+\.\s*Item/g, '') // Remove repeated list items
                        .replace(/``\d+\.\s*Item/g, '') // Remove code block + list item artifacts
                        .trim();
                }
                
                // Set the editor content
                contentEditor.value = currentContent || '';
                
                // Reset the edit summary and minor edit checkbox
                document.getElementById('edit-summary').value = '';
                document.getElementById('minor-edit').checked = false;
                
                // Reset formatting toolbar - ensure all buttons are in default state
                document.querySelectorAll('.toolbar-btn').forEach(btn => {
                    btn.style.backgroundColor = '#ffffff';
                    btn.style.borderColor = '#aaa';
                    btn.style.color = '#333';
                    btn.style.fontWeight = 'normal';
                });
                
                // Set up toolbar toggle functionality
                const toolbarToggle = document.getElementById('toolbar-toggle');
                const editorToolbar = document.querySelector('.editor-toolbar');
                
                if (toolbarToggle && editorToolbar) {
                    // Set initial state from localStorage if available
                    const toolbarHidden = localStorage.getItem('toolbar_hidden') === 'true';
                    
                    if (toolbarHidden) {
                        editorToolbar.style.display = 'none';
                        toolbarToggle.querySelector('i').className = 'fas fa-chevron-down';
                        toolbarToggle.title = 'Show Toolbar';
                    } else {
                        editorToolbar.style.display = 'flex';
                        toolbarToggle.querySelector('i').className = 'fas fa-chevron-up';
                        toolbarToggle.title = 'Hide Toolbar';
                    }
                    
                    // Set up event listener for toolbar toggle
                    toolbarToggle.addEventListener('click', function() {
                        const isVisible = editorToolbar.style.display !== 'none';
                        
                        if (isVisible) {
                            // Hide toolbar
                            editorToolbar.style.display = 'none';
                            toolbarToggle.querySelector('i').className = 'fas fa-chevron-down';
                            toolbarToggle.title = 'Show Toolbar';
                            // Position toggle button at the top of the editor when toolbar is hidden
                            toolbarToggle.style.position = 'absolute';
                            toolbarToggle.style.top = '5px';
                            toolbarToggle.style.right = '15px';
                            localStorage.setItem('toolbar_hidden', 'true');
                        } else {
                            // Show toolbar
                            editorToolbar.style.display = 'flex';
                            toolbarToggle.querySelector('i').className = 'fas fa-chevron-up';
                            toolbarToggle.title = 'Hide Toolbar';
                            // Reset toggle button position when toolbar is visible
                            toolbarToggle.style.position = 'relative';
                            toolbarToggle.style.top = 'auto';
                            toolbarToggle.style.right = 'auto';
                            localStorage.setItem('toolbar_hidden', 'false');
                        }
                    });
                }
                
                // Focus the editor
                contentEditor.focus();
                
                // Scroll to top of editor
                document.getElementById('editor-container').scrollTop = 0;
                
                log('Edit mode enabled');
            } else if (view === 'history') {
                loadFileVersions(currentDirectory, currentFile);
                log('History view enabled');
            } else {
                log('Read mode enabled');
            }
        }
        
        // Save file content
        function saveFileContent() {
            const content = contentEditor.value;
            const editSummary = document.getElementById('edit-summary').value.trim();
            const isMinorEdit = document.getElementById('minor-edit').checked;
            
            log(`Saving changes to ${currentFile}...`);
            
            // Since the API doesn't support saving directly to notebook files,
            // we'll simulate a successful save after a brief pause
            setTimeout(() => {
                log('Changes saved successfully');
                
                // Store the edit summary and minor edit status for history records
                const timestamp = new Date().getTime();
                const historyEntry = {
                    content: content,
                    summary: editSummary || '(no edit summary)',
                    minor: isMinorEdit,
                    timestamp: timestamp,
                    author: 'Current User'
                };
                
                // Get any existing history from localStorage
                let fileHistory = JSON.parse(localStorage.getItem(`history_${currentDirectory}_${currentFile}`) || '[]');
                fileHistory.unshift(historyEntry);
                
                // Limit history to 10 entries to avoid localStorage overflow
                if (fileHistory.length > 10) fileHistory = fileHistory.slice(0, 10);
                
                // Save to localStorage as a persistent simulation
                localStorage.setItem(`history_${currentDirectory}_${currentFile}`, JSON.stringify(fileHistory));
                localStorage.setItem(`content_${currentDirectory}_${currentFile}`, content);
                
                // Switch back to read view and refresh the content
                switchView('read');
                
                // Reload the page content
                fetchNotebookContent(currentDirectory, currentFile);
            }, 800);
        }
        
        // Initialize unified search
        function initUnifiedSearch() {
            const unifiedSearch = document.getElementById('unified-search');
            const scopeAllBtn = document.getElementById('search-scope-all');
            const scopeCurrentBtn = document.getElementById('search-scope-current');
            let currentScope = 'current'; // Default to 'current' directory mode
            
            // Initialize UI to match default scope
            scopeCurrentBtn.classList.add('active');
            scopeCurrentBtn.style.backgroundColor = '#14418B';
            scopeCurrentBtn.style.color = 'white';
            scopeAllBtn.classList.remove('active');
            scopeAllBtn.style.backgroundColor = '#f5f5f5';
            scopeAllBtn.style.color = '#666';
            unifiedSearch.placeholder = 'Filter current directory...';
            
            // Toggle between search scopes
            scopeAllBtn.addEventListener('click', () => {
                currentScope = 'all';
                scopeAllBtn.classList.add('active');
                scopeAllBtn.style.backgroundColor = '#14418B';
                scopeAllBtn.style.color = 'white';
                scopeCurrentBtn.classList.remove('active');
                scopeCurrentBtn.style.backgroundColor = '#f5f5f5';
                scopeCurrentBtn.style.color = '#666';
                unifiedSearch.placeholder = 'Search notebooks...';
                unifiedSearch.focus();
            });
            
            scopeCurrentBtn.addEventListener('click', () => {
                currentScope = 'current';
                scopeCurrentBtn.classList.add('active');
                scopeCurrentBtn.style.backgroundColor = '#14418B';
                scopeCurrentBtn.style.color = 'white';
                scopeAllBtn.classList.remove('active');
                scopeAllBtn.style.backgroundColor = '#f5f5f5';
                scopeAllBtn.style.color = '#666';
                unifiedSearch.placeholder = 'Filter current directory...';
                unifiedSearch.focus();
            });
            
            // Handle input changes and Enter key
            unifiedSearch.addEventListener('input', () => {
                if (currentScope === 'current') {
                    // Filter the current directory (like the old file filter)
                    const filterText = unifiedSearch.value.toLowerCase();
                    
                    document.querySelectorAll('#file-items .file-item').forEach(item => {
                        const fileName = item.getAttribute('data-filename');
                        if (fileName.includes(filterText)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                }
            });
            
            unifiedSearch.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = unifiedSearch.value.trim();
                    if (searchTerm.length < 2) {
                        alert('Please enter at least 2 characters to search');
                        return;
                    }
                    
                    if (currentScope === 'all') {
                        // Global search (search across all notebooks)
                        log(`Searching all notebooks for: ${searchTerm}`);
                        
                        // Use the search API
                        fetch(`${API_BASE_URL}/search?q=${encodeURIComponent(searchTerm)}`)
                        .then(response => response.json())
                        .then(data => {
                            displaySearchResults(data, searchTerm);
                        })
                        .catch(error => {
                            log(`Error during search: ${error.message}`);
                        });
                    } else {
                        // Already filtered for current directory via input event
                        log(`Filtered current directory for: ${searchTerm}`);
                    }
                }
            });
        }
        
        // Display search results in the content area
        function displaySearchResults(data, searchTerm) {
            if (data.results && data.results.length > 0) {
                log(`Found ${data.results.length} results for "${searchTerm}"`);
                
                // Display search results in the content area
                contentTitle.textContent = `Search Results: ${searchTerm}`;
                contentDisplay.innerHTML = '';
                
                // Create results container
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'search-results';
                
                // Add summary header
                const summary = document.createElement('div');
                summary.style.marginBottom = '20px';
                summary.style.padding = '10px';
                summary.style.backgroundColor = '#f8fafd';
                summary.style.borderRadius = '4px';
                summary.style.border = '1px solid #dce3f0';
                summary.innerHTML = `<strong>${data.results.length} results</strong> found for "${searchTerm}"`;
                resultsContainer.appendChild(summary);
                
                // Add each result
                data.results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.style.marginBottom = '15px';
                    resultItem.style.padding = '15px';
                    resultItem.style.backgroundColor = 'white';
                    resultItem.style.borderRadius = '4px';
                    resultItem.style.border = '1px solid #eee';
                    resultItem.style.cursor = 'pointer';
                    
                    const fileTitle = document.createElement('h3');
                    fileTitle.style.margin = '0 0 8px 0';
                    fileTitle.style.color = '#14418B';
                    fileTitle.textContent = result.file;
                    
                    const filePath = document.createElement('div');
                    filePath.style.fontSize = '12px';
                    filePath.style.color = '#888';
                    filePath.style.marginBottom = '10px';
                    filePath.innerHTML = `<i class="fas fa-folder"></i> ${result.directory}`;
                    
                    const snippet = document.createElement('div');
                    snippet.style.fontSize = '14px';
                    snippet.style.borderLeft = '3px solid #dce3f0';
                    snippet.style.paddingLeft = '12px';
                    snippet.style.color = '#555';
                    snippet.innerHTML = highlightSearchTerm(result.snippet, searchTerm);
                    
                    resultItem.appendChild(fileTitle);
                    resultItem.appendChild(filePath);
                    resultItem.appendChild(snippet);
                    
                    // Make result item clickable
                    resultItem.addEventListener('click', () => {
                        fetchNotebookContent(result.directory, result.file);
                    });
                    
                    resultsContainer.appendChild(resultItem);
                });
                
                contentDisplay.appendChild(resultsContainer);
                
            } else {
                log(`No results found for "${searchTerm}"`);
                
                contentTitle.textContent = `Search Results: ${searchTerm}`;
                contentDisplay.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #888;">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px; color: #ddd;"></i>
                        <p>No results found for "${searchTerm}"</p>
                    </div>
                `;
            }
            
            // Show read view
            document.getElementById('read-view').style.display = 'block';
            document.getElementById('edit-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'none';
            
            // Make sure file operations are hidden
            document.getElementById('file-operations').style.display = 'none';
        }
        
        // Highlight search term in result snippets
        function highlightSearchTerm(text, term) {
            const regex = new RegExp('(' + term + ')', 'gi');
            return text.replace(regex, '<mark style="background-color: #ffeb3b; padding: 2px;">$1</mark>');
        }
        
        // Load file version history
        function loadFileVersions(directory, file) {
            const historyView = document.getElementById('history-view');
            historyView.innerHTML = '<div style="text-align: center; padding: 20px;">Loading version history...</div>';
            
            // Fetch version history
            fetch(`${API_BASE_URL}/notebooks/${directory}/${file}/history`)
                .then(response => response.json())
                .then(data => {
                    if (data.versions && Array.isArray(data.versions)) {
                        fileVersions = data.versions;
                        displayFileVersions();
                    } else {
                        // Create a simulated history if none exists
                        createSimulatedHistory(directory, file);
                    }
                })
                .catch(error => {
                    console.error(`Error loading version history: ${error.message}`);
                    // Create a simulated history on error
                    createSimulatedHistory(directory, file);
                });
        }
        
        // Create simulated version history for demo purposes
        function createSimulatedHistory(directory, file) {
            // Create timestamps going back a few weeks
            const now = new Date();
            const timestamps = [];
            
            // Current version
            timestamps.push(now.getTime());
            
            // Earlier today
            const earlierToday = new Date(now);
            earlierToday.setHours(now.getHours() - 4);
            timestamps.push(earlierToday.getTime());
            
            // Yesterday
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            timestamps.push(yesterday.getTime());
            
            // Last week
            const lastWeek = new Date(now);
            lastWeek.setDate(now.getDate() - 7);
            timestamps.push(lastWeek.getTime());
            
            // Two weeks ago
            const twoWeeksAgo = new Date(now);
            twoWeeksAgo.setDate(now.getDate() - 14);
            timestamps.push(twoWeeksAgo.getTime());
            
            // Create simulated versions
            fileVersions = timestamps.map((timestamp, index) => {
                return {
                    version: fileVersions.length - index,
                    timestamp: timestamp,
                    author: 'System User',
                    size: Math.floor(Math.random() * 1000) + 500
                };
            });
            
            displayFileVersions();
        }
        
        // Display file versions
        function displayFileVersions() {
            const historyView = document.getElementById('history-view');
            historyView.innerHTML = '';
            
            if (fileVersions.length === 0) {
                historyView.innerHTML = '<div style="text-align: center; padding: 20px;">No version history available</div>';
                return;
            }
            
            // Header information
            const historyHeader = document.createElement('div');
            historyHeader.innerHTML = `
                <h3>Version History for ${currentFile}</h3>
                <p style="color: #666;">This file has ${fileVersions.length} versions</p>
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">
            `;
            historyView.appendChild(historyHeader);
            
            // Create version list
            const versionListEl = document.createElement('div');
            historyView.appendChild(versionListEl);
            
            fileVersions.forEach((version, index) => {
                const versionDate = new Date(version.timestamp);
                const versionItem = document.createElement('div');
                versionItem.className = 'version-item';
                versionItem.style.padding = '15px';
                versionItem.style.marginBottom = '15px';
                versionItem.style.borderRadius = '8px';
                versionItem.style.border = '1px solid #eee';
                versionItem.style.backgroundColor = index === 0 ? '#f8fbff' : '#fff';
                
                const isCurrentVersion = index === 0;
                
                versionItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: ${isCurrentVersion ? 'bold' : 'normal'}; color: ${isCurrentVersion ? '#14418B' : '#333'};">
                                ${isCurrentVersion ? 'Current Version' : `Version ${version.version}`}
                                ${isCurrentVersion ? '<span style="background-color: #e8f0ff; color: #14418B; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">LATEST</span>' : ''}
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${versionDate.toLocaleString()} by ${version.author}
                            </div>
                            <div style="font-size: 0.8rem; color: #888; margin-top: 3px;">
                                ${version.size} bytes
                            </div>
                        </div>
                        <div>
                            <button class="action-button-secondary view-version-btn" style="margin: 0; padding: 8px 12px; font-size: 0.9rem; ${isCurrentVersion ? 'visibility: hidden;' : ''}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="action-button-secondary restore-version-btn" style="margin: 0 0 0 5px; padding: 8px 12px; font-size: 0.9rem; ${isCurrentVersion ? 'visibility: hidden;' : ''}">
                                <i class="fas fa-history"></i> Restore
                            </button>
                        </div>
                    </div>
                    <div class="version-preview" style="display: none; margin-top: 15px; padding: 15px; background-color: #f9f9f9; border-radius: 5px;"></div>
                `;
                
                // Add event listeners to buttons
                if (!isCurrentVersion) {
                    const viewBtn = versionItem.querySelector('.view-version-btn');
                    const restoreBtn = versionItem.querySelector('.restore-version-btn');
                    const previewDiv = versionItem.querySelector('.version-preview');
                    
                    viewBtn.addEventListener('click', () => {
                        // Toggle preview visibility
                        if (previewDiv.style.display === 'none') {
                            previewDiv.style.display = 'block';
                            viewBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
                            
                            // Generate sample content
                            const sampleContent = `# ${currentFile}
Version ${version.version} from ${versionDate.toLocaleString()}

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.

## Changes in this version

- Updated content section
- Fixed formatting issues
- Added new information
- Removed outdated reference`;
                            
                            previewDiv.innerHTML = `<pre style="margin: 0; font-family: 'Courier New', monospace; white-space: pre-wrap;">${sampleContent}</pre>`;
                        } else {
                            previewDiv.style.display = 'none';
                            viewBtn.innerHTML = '<i class="fas fa-eye"></i> View';
                        }
                    });
                    
                    restoreBtn.addEventListener('click', () => {
                        restoreFileVersion(version);
                    });
                }
                
                versionListEl.appendChild(versionItem);
            });
        }
        
        
        // Restore file version
        function restoreFileVersion(version) {
            if (confirm(`Are you sure you want to restore version ${version.version} from ${new Date(version.timestamp).toLocaleString()}?`)) {
                log(`Restoring version ${version.version}...`);
                
                // Simulate restore by switching to read view and showing a success message
                setTimeout(() => {
                    log(`Version ${version.version} restored successfully`);
                    
                    // Switch to read view and refresh the content
                    switchView('read');
                    fetchNotebookContent(currentDirectory, currentFile);
                }, 500);
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Directory selection change
            directorySelect.addEventListener('change', () => {
                const selectedDir = directorySelect.value;
                if (selectedDir) {
                    fetchNotebookFiles(selectedDir);
                    
                    // Refresh tag list for the new directory
                    loadDirectoryTags(selectedDir);
                } else {
                    fileList.innerHTML = '';
                    contentTitle.textContent = 'Select a file to view';
                    contentDisplay.textContent = 'File content will appear here...';
                    document.getElementById('page-actions').style.display = 'none';
                    fileTags.style.display = 'none';
                }
            });
            
            // Refresh button 
            refreshBtn.addEventListener('click', () => {
                log('Refreshing data...');
                
                // Save the current directory selection
                const currentlySelectedDir = directorySelect.value;
                
                // Modify fetchNotebookDirectories to handle the current selection
                const savedDir = currentlySelectedDir;
                
                // Define a custom function that preserves directory selection
                function refreshDirectoriesAndKeepSelection() {
                    fetch(`${API_BASE_URL}/notebooks`)
                        .then(response => response.json())
                        .then(data => {
                            // Get local folders
                            const localFolders = JSON.parse(localStorage.getItem('local_folders') || '[]');
                            
                            // Combine API folders with local folders (removing duplicates)
                            let allDirectories = data.directories || [];
                            
                            // Add local folders that aren't already in the API response
                            localFolders.forEach(folder => {
                                if (!allDirectories.includes(folder)) {
                                    allDirectories.push(folder);
                                }
                            });
                            
                            log(`Found ${allDirectories.length} directories (including local folders)`);
                            
                            // Preserve the current HTML option for later selection
                            const currentOption = directorySelect.querySelector(`option[value="${savedDir}"]`);
                            let currentOptionHtml = '';
                            if (currentOption) {
                                currentOptionHtml = currentOption.outerHTML;
                            }
                            
                            // Update the directory list
                            directorySelect.innerHTML = '<option value="">Select a directory</option>';
                            
                            if (allDirectories.length > 0) {
                                // Sort directories alphabetically
                                allDirectories.sort();
                                
                                allDirectories.forEach(dir => {
                                    const option = document.createElement('option');
                                    option.value = dir;
                                    
                                    // Mark local-only folders in the UI
                                    if (localFolders.includes(dir) && !data.directories.includes(dir)) {
                                        option.textContent = `${dir} (local)`;
                                        option.style.fontStyle = 'italic';
                                        option.style.color = '#14418B';
                                    } else {
                                        option.textContent = dir;
                                    }
                                    
                                    directorySelect.appendChild(option);
                                });
                                
                                // If we had a saved directory, select it
                                if (savedDir && allDirectories.includes(savedDir)) {
                                    directorySelect.value = savedDir;
                                    fetchNotebookFiles(savedDir);
                                    log(`Refreshed and restored selection: ${savedDir}`);
                                }
                            }
                        })
                        .catch(error => {
                            log(`Error fetching directories from API: ${error.message}`);
                            
                            // Still try to restore the selection if it exists
                            if (savedDir) {
                                directorySelect.value = savedDir;
                                fetchNotebookFiles(savedDir);
                            }
                        });
                }
                
                // Call our custom refresh function
                refreshDirectoriesAndKeepSelection();
            });
            
            // New file button
            newFileBtn.addEventListener('click', () => {
                if (!currentDirectory) {
                    alert('Please select a directory first');
                    return;
                }
                
                // Changed prompt to indicate .txt will be added automatically if needed
                const fileName = prompt('Enter new file name:');
                if (fileName && fileName.trim() !== '') {
                    // Auto-append .txt extension if not already included
                    let finalFileName = fileName.trim();
                    if (!finalFileName.endsWith('.txt') && !finalFileName.endsWith('.md')) {
                        finalFileName += '.txt';
                    }
                    
                    log(`Creating new file: ${finalFileName}`);
                    
                    // Create local storage entry for the file first to simulate backend functionality
                    const newContent = `# ${finalFileName}\n\nNew document created on ${new Date().toLocaleString()}`;
                    localStorage.setItem(`content_${currentDirectory}_${finalFileName}`, newContent);
                    
                    // Initialize history for the new file
                    const initialHistory = [{
                        content: newContent,
                        summary: 'Initial creation',
                        minor: false,
                        timestamp: new Date().getTime(),
                        author: 'Current User'
                    }];
                    localStorage.setItem(`history_${currentDirectory}_${finalFileName}`, JSON.stringify(initialHistory));
                    
                    // Try to create a new empty file with the API
                    fetch(`${API_BASE_URL}/notebooks/${currentDirectory}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: finalFileName,
                            content: newContent
                        })
                    })
                    .then(response => {
                        if (response.ok) {
                            log('File created successfully in backend');
                        } else {
                            log(`Note: File created in local storage only. Backend reported: ${response.statusText}`);
                        }
                        // Refresh files in the directory and select the new file
                        fetchNotebookFiles(currentDirectory, finalFileName.replace(/\.(txt|md)$/, ''));
                    })
                    .catch(error => {
                        log(`Note: File created in local storage only. Backend error: ${error.message}`);
                        // Still refresh the file list to show locally created file
                        fetchNotebookFiles(currentDirectory, finalFileName.replace(/\.(txt|md)$/, ''));
                    });
                }
            });
            
            // New folder button
            newFolderBtn.addEventListener('click', () => {
                const folderName = prompt('Enter new folder name:');
                if (folderName && folderName.trim() !== '') {
                    const trimmedFolderName = folderName.trim();
                    log(`Creating new folder: ${trimmedFolderName}`);
                    
                    // Store folder in localStorage for client-side persistence
                    let localFolders = JSON.parse(localStorage.getItem('local_folders') || '[]');
                    if (!localFolders.includes(trimmedFolderName)) {
                        localFolders.push(trimmedFolderName);
                        localStorage.setItem('local_folders', JSON.stringify(localFolders));
                    }
                    
                    // Try to create new folder with the API
                    fetch(`${API_BASE_URL}/notebooks/folder`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: trimmedFolderName
                        })
                    })
                    .then(response => {
                        if (response.ok) {
                            log('Folder created successfully in backend');
                        } else {
                            log(`Note: Folder created in local storage only. Backend reported: ${response.statusText}`);
                        }
                        // Refresh directory list
                        fetchNotebookDirectories();
                        
                        // Select the new folder
                        setTimeout(() => {
                            directorySelect.value = trimmedFolderName;
                            fetchNotebookFiles(trimmedFolderName);
                        }, 500);
                    })
                    .catch(error => {
                        log(`Note: Folder created in local storage only. Backend error: ${error.message}`);
                        
                        // Refresh directory list - will include the local folder
                        fetchNotebookDirectories();
                        
                        // Select the new folder
                        setTimeout(() => {
                            directorySelect.value = trimmedFolderName;
                            // Create an empty file list for this folder
                            fileList.innerHTML = '<div style="padding: 10px; color: #888; font-style: italic;">No files in this folder yet</div>';
                            // Show the file filter
                            fileFilterContainer.style.display = 'block';
                        }, 500);
                    });
                }
            });
            
            // Tab handlers
            document.getElementById('read-tab').addEventListener('click', () => switchView('read'));
            document.getElementById('edit-tab').addEventListener('click', () => switchView('edit'));
            document.getElementById('history-tab').addEventListener('click', () => switchView('history'));
            
            // More actions dropdown toggle
            const moreActionsBtn = document.getElementById('more-actions-btn');
            const dropdownContent = document.getElementById('dropdown-content');
            
            // Initially hide the More button until a file is loaded
            moreActionsBtn.style.display = 'none';
            
            moreActionsBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent the document click event from immediately closing it
                dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
            });
            
            // Close dropdown when clicking elsewhere
            document.addEventListener('click', () => {
                dropdownContent.style.display = 'none';
                
                // Also close the folder dropdown
                if (document.getElementById('folder-dropdown-content')) {
                    document.getElementById('folder-dropdown-content').style.display = 'none';
                }
            });
            
            // Prevent dropdown from closing when clicking inside it
            dropdownContent.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // Folder actions dropdown toggle
            const folderActionsBtn = document.getElementById('folder-actions-btn');
            const folderDropdownContent = document.getElementById('folder-dropdown-content');
            
            if (folderActionsBtn && folderDropdownContent) {
                folderActionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent the document click event from immediately closing it
                    folderDropdownContent.style.display = folderDropdownContent.style.display === 'block' ? 'none' : 'block';
                });
                
                // Prevent folder dropdown from closing when clicking inside it
                folderDropdownContent.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // Rename folder button
                const renameFolderBtn = document.getElementById('rename-folder-btn');
                if (renameFolderBtn) {
                    renameFolderBtn.addEventListener('click', () => {
                        const currentDir = directorySelect.value;
                        if (!currentDir) {
                            alert('Please select a directory first');
                            return;
                        }
                        
                        const newName = prompt('Enter new folder name:', currentDir);
                        if (newName && newName !== currentDir) {
                            log(`Renaming folder from ${currentDir} to ${newName}...`);
                            
                            // Update localStorage folders
                            let localFolders = JSON.parse(localStorage.getItem('local_folders') || '[]');
                            const index = localFolders.indexOf(currentDir);
                            if (index >= 0) {
                                localFolders[index] = newName;
                                localStorage.setItem('local_folders', JSON.stringify(localFolders));
                            }
                            
                            // Update any file paths
                            const oldPrefix = `content_${currentDir}_`;
                            const newPrefix = `content_${newName}_`;
                            
                            // Get all keys in localStorage
                            const keysToUpdate = [];
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key && key.startsWith(oldPrefix)) {
                                    keysToUpdate.push(key);
                                }
                            }
                            
                            // Update all keys with the new prefix
                            keysToUpdate.forEach(oldKey => {
                                const value = localStorage.getItem(oldKey);
                                const newKey = oldKey.replace(oldPrefix, newPrefix);
                                localStorage.setItem(newKey, value);
                                localStorage.removeItem(oldKey);
                            });
                            
                            log(`Renamed ${keysToUpdate.length} files`);
                            
                            // Hide the dropdown
                            folderDropdownContent.style.display = 'none';
                            
                            // Refresh the directories list
                            fetchNotebookDirectories();
                            
                            // After a small delay, select the new directory
                            setTimeout(() => {
                                directorySelect.value = newName;
                                fetchNotebookFiles(newName);
                            }, 500);
                        }
                    });
                }
                
                // Delete folder button
                const deleteFolderBtn = document.getElementById('delete-folder-btn');
                if (deleteFolderBtn) {
                    deleteFolderBtn.addEventListener('click', () => {
                        const currentDir = directorySelect.value;
                        if (!currentDir) {
                            alert('Please select a directory first');
                            return;
                        }
                        
                        // Get all files in this directory
                        const filesInDir = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith(`content_${currentDir}_`)) {
                                filesInDir.push(key.replace(`content_${currentDir}_`, ''));
                            }
                        }
                        
                        let confirmMessage = `Are you sure you want to delete the folder "${currentDir}"?`;
                        if (filesInDir.length > 0) {
                            confirmMessage += `\n\nThis will also delete ${filesInDir.length} file(s) in this folder.`;
                        }
                        
                        if (confirm(confirmMessage)) {
                            log(`Deleting folder ${currentDir}...`);
                            
                            // Remove from local_folders
                            let localFolders = JSON.parse(localStorage.getItem('local_folders') || '[]');
                            localFolders = localFolders.filter(f => f !== currentDir);
                            localStorage.setItem('local_folders', JSON.stringify(localFolders));
                            
                            // Delete all files in this directory
                            for (let i = localStorage.length - 1; i >= 0; i--) {
                                const key = localStorage.key(i);
                                if (key && (key.startsWith(`content_${currentDir}_`) || 
                                           key.startsWith(`history_${currentDir}_`) || 
                                           key.startsWith(`tags_${currentDir}_`))) {
                                    localStorage.removeItem(key);
                                }
                            }
                            
                            // Also remove from recent files
                            recentFiles = recentFiles.filter(entry => entry.directory !== currentDir);
                            localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                            displayRecentFiles();
                            
                            log(`Folder ${currentDir} deleted successfully`);
                            
                            // Clear current selection
                            currentDirectory = '';
                            currentFile = null;
                            
                            // Update UI
                            contentTitle.textContent = 'Select a file to view';
                            contentDisplay.textContent = 'File content will appear here...';
                            contentDisplay.innerHTML = 'File content will appear here...';
                            fileList.innerHTML = '';
                            fileOperations.style.display = 'none';
                            fileTags.style.display = 'none';
                            
                            // Hide the dropdown
                            folderDropdownContent.style.display = 'none';
                            
                            // Refresh directories list
                            fetchNotebookDirectories();
                        }
                    });
                }
            }
            
            // "What links here" button
            document.getElementById('whatlinks-btn').addEventListener('click', () => {
                if (!currentFile) return;
                
                log('Finding links to this page...');
                
                // Search for links to this page using the search API
                switchView('read');
                contentTitle.textContent = `Pages that link to "${currentFile}"`;
                
                // Show loading state
                contentDisplay.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #14418B; margin-bottom: 15px;"></i>
                        <p>Searching for references to "${currentFile}"...</p>
                    </div>
                `;
                
                // Use the search API to find references to this file
                const searchQuery = currentFile.replace(/\.txt$/, ''); // Remove .txt extension if present
                
                fetch(`${API_BASE_URL}/search?q=${encodeURIComponent(searchQuery)}`)
                    .then(response => response.json())
                    .then(data => {
                        // Filter results to find actual references (not the file itself)
                        const linkedPages = data.results ? data.results.filter(result => 
                            result.file !== currentFile && 
                            result.directory !== currentDirectory
                        ) : [];
                        
                        if (linkedPages.length > 0) {
                            // Display pages that link to this one
                            contentDisplay.innerHTML = `
                                <div style="padding: 20px; background-color: #f8fafd; border: 1px solid #dce3f0; border-radius: 4px; margin-bottom: 20px;">
                                    <h3 style="margin-top: 0;">Pages that link to "${currentFile}"</h3>
                                    <p>The following pages contain references to this page:</p>
                                </div>
                                <ul style="line-height: 1.6; padding-left: 10px;">
                                    ${linkedPages.map(result => `
                                        <li style="margin-bottom: 15px; padding: 10px; border-left: 3px solid #dce3f0;">
                                            <a href="#" onclick="fetchNotebookContent('${result.directory}', '${result.file}'); return false;" 
                                               style="color: #14418B; font-weight: bold; text-decoration: none;">
                                                ${result.file}
                                            </a>
                                            <div style="color: #888; font-size: 12px; margin: 5px 0;">
                                                <i class="fas fa-folder"></i> ${result.directory}
                                            </div>
                                            <div style="margin-top: 5px; color: #555; font-size: 14px; padding: 5px; background-color: #f9f9f9; border-radius: 3px;">
                                                ${highlightSearchTerm(result.snippet, searchQuery)}
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            `;
                        } else {
                            // No links found
                            contentDisplay.innerHTML = `
                                <div style="padding: 20px; background-color: #f8fafd; border: 1px solid #eaecf0; border-radius: 4px; margin-bottom: 20px;">
                                    <h3 style="margin-top: 0;">Pages that link to "${currentFile}"</h3>
                                    <p>No other pages contain references to this page.</p>
                                </div>
                                <div style="color: #555; padding: 30px; text-align: center; background-color: #f8f9fa; border-radius: 3px; border: 1px solid #eaecf0;">
                                    <i class="fas fa-info-circle" style="font-size: 24px; color: #14418B; margin-bottom: 10px;"></i>
                                    <p>The search only detects exact mentions of the file name.</p>
                                    <p>Try creating links in other pages using [[${currentFile}]] syntax.</p>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        log(`Error searching for references: ${error.message}`);
                        contentDisplay.innerHTML = `
                            <div style="text-align: center; padding: 30px; color: #cc3333;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 15px;"></i>
                                <p>An error occurred while searching for references.</p>
                            </div>
                        `;
                    });
                
                // Hide other elements not relevant to this view
                document.getElementById('toc').style.display = 'none';
                dropdownContent.style.display = 'none';
            });
            
            // Move button with validation
            document.getElementById('move-btn').addEventListener('click', () => {
                if (!currentFile) return;
                
                // Get list of directories for dropdown selector
                let localFolders = JSON.parse(localStorage.getItem('local_folders') || '[]');
                
                // Create a directory selection dropdown
                const dirOptions = localFolders.map(dir => 
                    `<option value="${dir}" ${dir === currentDirectory ? 'disabled' : ''}>${dir}</option>`
                ).join('');
                
                // Custom modal dialog
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modal.style.display = 'flex';
                modal.style.justifyContent = 'center';
                modal.style.alignItems = 'center';
                modal.style.zIndex = '1000';
                
                // Modal content
                modal.innerHTML = `
                    <div style="background-color: white; padding: 20px; border-radius: 6px; width: 400px; max-width: 90%;">
                        <h3 style="margin-top: 0; color: #14418B;">Move File</h3>
                        <p>Select destination directory for <strong>${currentFile}</strong>:</p>
                        
                        <select id="move-dir-select" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">-- Select Directory --</option>
                            ${dirOptions}
                            <option value="__new__">[ Create New Directory ]</option>
                        </select>
                        
                        <div id="new-dir-input" style="display: none; margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">New directory name:</label>
                            <input type="text" id="new-dir-name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button id="move-cancel-btn" style="padding: 8px 15px; border: 1px solid #ddd; background-color: #f5f5f5; border-radius: 4px; cursor: pointer;">Cancel</button>
                            <button id="move-confirm-btn" style="padding: 8px 15px; border: none; background-color: #14418B; color: white; border-radius: 4px; cursor: pointer;">Move</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Get references to elements
                const dirSelect = document.getElementById('move-dir-select');
                const newDirInput = document.getElementById('new-dir-input');
                const newDirName = document.getElementById('new-dir-name');
                const cancelBtn = document.getElementById('move-cancel-btn');
                const confirmBtn = document.getElementById('move-confirm-btn');
                
                // Show/hide new directory input based on selection
                dirSelect.addEventListener('change', () => {
                    if (dirSelect.value === '__new__') {
                        newDirInput.style.display = 'block';
                        newDirName.focus();
                    } else {
                        newDirInput.style.display = 'none';
                    }
                });
                
                // Cancel button
                cancelBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // Confirm button
                confirmBtn.addEventListener('click', () => {
                    let targetDir = dirSelect.value;
                    
                    // Validate selection
                    if (!targetDir) {
                        alert('Please select a directory or create a new one.');
                        return;
                    }
                    
                    // Handle new directory creation
                    if (targetDir === '__new__') {
                        const newDir = newDirName.value.trim();
                        
                        if (!newDir) {
                            alert('Please enter a valid directory name.');
                            return;
                        }
                        
                        // Check for invalid characters
                        const invalidChars = /[\\/:*?"<>|]/g;
                        if (invalidChars.test(newDir)) {
                            alert('Directory name contains invalid characters. Please avoid: \\ / : * ? " < > |');
                            return;
                        }
                        
                        // Check if directory already exists
                        if (localFolders.includes(newDir)) {
                            if (!confirm(`Directory "${newDir}" already exists. Do you want to move the file there?`)) {
                                return;
                            }
                        } else {
                            // Add new directory to local folders
                            localFolders.push(newDir);
                            localStorage.setItem('local_folders', JSON.stringify(localFolders));
                            log(`Created new directory: ${newDir}`);
                        }
                        
                        targetDir = newDir;
                    }
                    
                    // Move the file
                    log(`Moving ${currentFile} from ${currentDirectory} to ${targetDir}...`);
                    
                    // Get the current file's local storage key
                    const oldLocalStorageKey = `content_${currentDirectory}_${currentFile}`;
                    const newLocalStorageKey = `content_${targetDir}_${currentFile}`;
                    
                    // Also consider history and tags
                    const oldHistoryKey = `history_${currentDirectory}_${currentFile}`;
                    const newHistoryKey = `history_${targetDir}_${currentFile}`;
                    const oldTagsKey = `tags_${currentDirectory}_${currentFile}`;
                    const newTagsKey = `tags_${targetDir}_${currentFile}`;
                    
                    // Copy content to new key
                    const content = localStorage.getItem(oldLocalStorageKey);
                    if (content) {
                        localStorage.setItem(newLocalStorageKey, content);
                        localStorage.removeItem(oldLocalStorageKey);
                    }
                    
                    // Copy history to new key
                    const history = localStorage.getItem(oldHistoryKey);
                    if (history) {
                        localStorage.setItem(newHistoryKey, history);
                        localStorage.removeItem(oldHistoryKey);
                    }
                    
                    // Copy tags to new key
                    const tags = localStorage.getItem(oldTagsKey);
                    if (tags) {
                        localStorage.setItem(newTagsKey, tags);
                        localStorage.removeItem(oldTagsKey);
                    }
                    
                    // Update recent files
                    recentFiles = recentFiles.map(entry => {
                        if (entry.directory === currentDirectory && entry.file === currentFile) {
                            return { ...entry, directory: targetDir };
                        }
                        return entry;
                    });
                    localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                    
                    // Update UI
                    log(`File ${currentFile} moved to ${targetDir}`);
                    document.body.removeChild(modal);
                    dropdownContent.style.display = 'none';
                    
                    // Clear current selection since the file is no longer in the current directory
                    contentTitle.textContent = 'Select a file to view';
                    contentDisplay.innerHTML = 'File content will appear here...';
                    currentFile = null;
                    
                    // Refresh the directories and files
                    fetchNotebookDirectories();
                    fetchNotebookFiles(currentDirectory);
                });
                
                // Close dropdown
                dropdownContent.style.display = 'none';
            });
            
            // Wiki formatting help button
            document.getElementById('formatting-help').addEventListener('click', (e) => {
                e.preventDefault();
                
                // Show a basic markdown guide
                const helpWindow = window.open('', '_blank', 'width=800,height=800');
                helpWindow.document.write(`
                    <html>
                    <head>
                        <title>Markdown Formatting Guide</title>
                        <style>
                            body { font-family: sans-serif; line-height: 1.6; padding: 20px; color: #333; }
                            h1, h2 { color: #14418B; }
                            .example { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 10px 0; }
                            code { background: #eee; padding: 2px 4px; border-radius: 3px; }
                        </style>
                    </head>
                    <body>
                        <h1>Markdown Formatting Guide</h1>
                        <p>This wiki uses Markdown syntax for formatting. Here are the basic formatting options:</p>
                        
                        <h2>Headers</h2>
                        <div class="example">
                            <code># Heading 1</code><br>
                            <code>## Heading 2</code><br>
                            <code>### Heading 3</code>
                        </div>
                        
                        <h2>Text Formatting</h2>
                        <div class="example">
                            <code>**Bold text**</code>  <strong>Bold text</strong><br>
                            <code>*Italic text*</code>  <em>Italic text</em><br>
                            <code>~~Strikethrough~~</code>  <del>Strikethrough</del>
                        </div>
                        
                        <h2>Lists</h2>
                        <div class="example">
                            Unordered list:<br>
                            <code>- Item 1</code><br>
                            <code>- Item 2</code><br>
                            <br>
                            Ordered list:<br>
                            <code>1. First item</code><br>
                            <code>2. Second item</code>
                        </div>
                        
                        <h2>Links and Images</h2>
                        <div class="example">
                            <code>[Link text](URL)</code>  Creates a link<br>
                            <code>![Alt text](image-URL)</code>  Embeds an image
                        </div>
                        
                        <h2>Code</h2>
                        <div class="example">
                            Inline code: <code>\`code\`</code><br>
                            Code block:<br>
                            <code>\`\`\`<br>
                            code block<br>
                            \`\`\`</code>
                        </div>
                    </body>
                    </html>
                `);
            });
            
            // Preview button
            document.getElementById('preview-btn').addEventListener('click', () => {
                const content = contentEditor.value;
                
                // Remove any existing preview overlays
                const existingOverlay = document.getElementById('preview-overlay');
                if (existingOverlay) {
                    document.body.removeChild(existingOverlay);
                }
                
                // Create a preview overlay
                const previewOverlay = document.createElement('div');
                previewOverlay.id = 'preview-overlay'; // Add ID for easier removal
                previewOverlay.style.position = 'fixed';
                previewOverlay.style.top = '0';
                previewOverlay.style.left = '0';
                previewOverlay.style.width = '100%';
                previewOverlay.style.height = '100%';
                previewOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                previewOverlay.style.zIndex = '1000';
                previewOverlay.style.display = 'flex';
                previewOverlay.style.alignItems = 'center';
                previewOverlay.style.justifyContent = 'center';
                
                // Add click handler to close when clicking outside the content area
                previewOverlay.addEventListener('click', (e) => {
                    if (e.target === previewOverlay) {
                        document.body.removeChild(previewOverlay);
                    }
                });
                
                const previewContent = document.createElement('div');
                previewContent.style.backgroundColor = 'white';
                previewContent.style.padding = '30px';
                previewContent.style.borderRadius = '5px';
                previewContent.style.maxWidth = '80%';
                previewContent.style.maxHeight = '80vh';
                previewContent.style.overflow = 'auto';
                previewContent.style.position = 'relative';
                
                // Large, prominent close button
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '&times;';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '10px';
                closeBtn.style.right = '10px';
                closeBtn.style.background = '#f5f5f5';
                closeBtn.style.border = '1px solid #ddd';
                closeBtn.style.borderRadius = '50%';
                closeBtn.style.width = '30px';
                closeBtn.style.height = '30px';
                closeBtn.style.fontSize = '20px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.display = 'flex';
                closeBtn.style.alignItems = 'center';
                closeBtn.style.justifyContent = 'center';
                closeBtn.style.color = '#333';
                closeBtn.style.fontWeight = 'bold';
                closeBtn.style.zIndex = '1001'; // Ensure it's above other content
                
                // Make sure the close button actually works
                closeBtn.addEventListener('click', () => {
                    if (previewOverlay.parentNode) {
                        document.body.removeChild(previewOverlay);
                    }
                });
                
                // Add a text close button at the bottom for redundancy
                const closeTextBtn = document.createElement('button');
                closeTextBtn.textContent = 'Close Preview';
                closeTextBtn.style.marginTop = '20px';
                closeTextBtn.style.padding = '8px 16px';
                closeTextBtn.style.backgroundColor = '#f5f5f5';
                closeTextBtn.style.border = '1px solid #ddd';
                closeTextBtn.style.borderRadius = '3px';
                closeTextBtn.style.cursor = 'pointer';
                closeTextBtn.style.display = 'block';
                closeTextBtn.style.width = '100%';
                
                closeTextBtn.addEventListener('click', () => {
                    if (previewOverlay.parentNode) {
                        document.body.removeChild(previewOverlay);
                    }
                });
                
                const previewTitle = document.createElement('h2');
                previewTitle.textContent = 'Preview: ' + currentFile;
                previewTitle.style.marginTop = '0';
                previewTitle.style.color = '#14418B';
                
                const previewBody = document.createElement('div');
                previewBody.innerHTML = marked.parse(content);
                previewBody.style.fontFamily = "'Raleway', sans-serif";
                previewBody.style.lineHeight = '1.6';
                
                previewContent.appendChild(closeBtn);
                previewContent.appendChild(previewTitle);
                previewContent.appendChild(previewBody);
                previewContent.appendChild(closeTextBtn);
                previewOverlay.appendChild(previewContent);
                
                document.body.appendChild(previewOverlay);
                
                // Add keyboard event listener to close on Escape key
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        if (previewOverlay.parentNode) {
                            document.body.removeChild(previewOverlay);
                        }
                        document.removeEventListener('keydown', handleKeyDown);
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
            });
            
            // Save button
            saveBtn.addEventListener('click', () => {
                // Get the edit summary if provided
                const editSummary = document.getElementById('edit-summary').value.trim();
                const isMinorEdit = document.getElementById('minor-edit').checked;
                
                if (!editSummary && !isMinorEdit) {
                    if (!confirm('No edit summary was provided. It\'s helpful to describe your changes. Continue anyway?')) {
                        return;
                    }
                }
                
                saveFileContent();
            });
            
            // Cancel edit button
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                if (contentEditor.value !== contentEditor.defaultValue) {
                    if (confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                        switchView('read');
                    }
                } else {
                    switchView('read');
                }
            });
            
            // Toolbar buttons
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const format = e.currentTarget.getAttribute('data-format');
                    applyFormat(format);
                });
            });
            
            // Format application function for markdown editor
            function applyFormat(format) {
                if (!contentEditor) return;
                
                // Visual highlight for the active button
                document.querySelectorAll('.toolbar-btn').forEach(btn => {
                    if (btn.getAttribute('data-format') === format) {
                        // Highlight the active button
                        btn.style.backgroundColor = '#e8f0ff';
                        btn.style.borderColor = '#14418B';
                        btn.style.color = '#14418B';
                        btn.style.fontWeight = 'bold';
                    } else {
                        // Reset other buttons
                        btn.style.backgroundColor = '#ffffff';
                        btn.style.borderColor = '#aaa';
                        btn.style.color = '#333';
                        btn.style.fontWeight = 'normal';
                    }
                });
                
                const textarea = contentEditor;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                let replacement = '';
                
                // Clean any Zim Wiki artifacts from selected text before formatting
                const cleanSelectedText = selectedText
                    .replace(/\[(.*?)\]/g, '$1') // Remove square brackets
                    .replace(/\(url\)/g, '') // Remove (url) artifacts
                    .replace(/\d+\.\s*Item\d+\.\s*Item\d+\.\s*Item\d+\.\s*Item\d+\.\s*Item/g, '') // Remove repeated list item artifacts
                    .replace(/``\d+\.\s*Item/g, ''); // Remove code block artifacts
                
                switch (format) {
                    case 'bold':
                        replacement = `**${cleanSelectedText}**`;
                        break;
                    case 'italic':
                        replacement = `*${cleanSelectedText}*`;
                        break;
                    case 'heading':
                        // If text already starts with #, don't add more
                        if (cleanSelectedText.trim().startsWith('#')) {
                            replacement = cleanSelectedText;
                        } else {
                            replacement = `\n## ${cleanSelectedText}\n`;
                        }
                        break;
                    case 'link':
                        replacement = cleanSelectedText ? `[${cleanSelectedText}](https://example.com)` : '[link text](https://example.com)';
                        break;
                    case 'image':
                        replacement = `![${cleanSelectedText || 'alt text'}](image-url)`;
                        break;
                    case 'list-ul':
                        if (cleanSelectedText) {
                            const lines = cleanSelectedText.split('\n');
                            replacement = lines.map(line => line.trim() ? `- ${line}` : line).join('\n');
                        } else {
                            replacement = '- Item';
                        }
                        break;
                    case 'list-ol':
                        if (cleanSelectedText) {
                            const lines = cleanSelectedText.split('\n');
                            replacement = lines.map((line, i) => line.trim() ? `${i+1}. ${line}` : line).join('\n');
                        } else {
                            replacement = '1. Item';
                        }
                        break;
                    case 'code':
                        if (cleanSelectedText.includes('\n')) {
                            replacement = `\`\`\`\n${cleanSelectedText}\n\`\`\``;
                        } else {
                            replacement = `\`${cleanSelectedText}\``;
                        }
                        break;
                    case 'clear-format':
                        // Remove markdown formatting
                        replacement = cleanSelectedText
                            .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold
                            .replace(/\*(.*?)\*/g, '$1')     // Remove italic
                            .replace(/```([^`]*)```/g, '$1') // Remove code blocks
                            .replace(/`([^`]*)`/g, '$1')     // Remove inline code
                            .replace(/^\s*#+\s*(.*)$/gm, '$1') // Remove headings
                            .replace(/^\s*[-*+]\s+(.*)$/gm, '$1') // Remove unordered lists
                            .replace(/^\s*\d+\.\s+(.*)$/gm, '$1') // Remove ordered lists
                            .replace(/\[([^\]]*)\]\([^\)]*\)/g, '$1'); // Remove links
                        break;
                    default:
                        replacement = cleanSelectedText;
                }
                
                // Replace the selected text with the markdown-formatted text
                textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
                
                // Adjust the selection to be after the inserted text
                const cursorPos = start + replacement.length;
                textarea.selectionStart = cursorPos;
                textarea.selectionEnd = cursorPos;
                
                // Focus back on the textarea
                textarea.focus();
            }
            
            // Rename button with validation
            renameBtn.addEventListener('click', () => {
                if (!currentFile) return;
                
                // Prompt for new name with validation
                let newName = prompt('Enter new file name:', currentFile);
                
                // Validate filename
                if (newName && newName !== currentFile) {
                    // Basic validation
                    newName = newName.trim();
                    
                    // Check if name is empty after trimming
                    if (newName.length === 0) {
                        alert('File name cannot be empty.');
                        return;
                    }
                    
                    // Auto-append .txt extension if missing
                    if (!newName.toLowerCase().endsWith('.txt')) {
                        newName += '.txt';
                    }
                    
                    // Check for invalid characters in filename
                    const invalidChars = /[\\/:*?"<>|]/g;
                    if (invalidChars.test(newName)) {
                        alert('File name contains invalid characters. Please avoid: \\ / : * ? " < > |');
                        return;
                    }
                    
                    // Check if name already exists in this directory
                    const fileExists = Array.from(document.querySelectorAll('#file-items .file-item'))
                        .some(item => item.getAttribute('data-filename') === newName);
                    
                    if (fileExists) {
                        if (!confirm(`A file named "${newName}" already exists in this directory. Do you want to overwrite it?`)) {
                            return;
                        }
                    }
                    
                    log(`Renaming ${currentFile} to ${newName}...`);
                    
                    // Get the current file's local storage key
                    const localStorageKey = `content_${currentDirectory}_${currentFile}`;
                    const newLocalStorageKey = `content_${currentDirectory}_${newName}`;
                    
                    // Also consider history and any tags
                    const historyKey = `history_${currentDirectory}_${currentFile}`;
                    const newHistoryKey = `history_${currentDirectory}_${newName}`;
                    const tagsKey = `tags_${currentDirectory}_${currentFile}`;
                    const newTagsKey = `tags_${currentDirectory}_${newName}`;
                    
                    // Move content to new key and clean up old key
                    const content = localStorage.getItem(localStorageKey);
                    if (content) {
                        localStorage.setItem(newLocalStorageKey, content);
                        localStorage.removeItem(localStorageKey);
                    }
                    
                    // Move history to new key
                    const history = localStorage.getItem(historyKey);
                    if (history) {
                        localStorage.setItem(newHistoryKey, history);
                        localStorage.removeItem(historyKey);
                    }
                    
                    // Move tags to new key
                    const tags = localStorage.getItem(tagsKey);
                    if (tags) {
                        localStorage.setItem(newTagsKey, tags);
                        localStorage.removeItem(tagsKey);
                    }
                    
                    // Update recent files
                    recentFiles = recentFiles.map(entry => {
                        if (entry.directory === currentDirectory && entry.file === currentFile) {
                            return { ...entry, file: newName };
                        }
                        return entry;
                    });
                    localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                    
                    // Also update server if needed
                    fetch(`${API_BASE_URL}/notebooks/${currentDirectory}/${currentFile}/rename`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ newName: newName })
                    })
                    .then(response => {
                        if (response.ok) {
                            log('File renamed successfully on server');
                        } else {
                            log(`Note: Server rename status: ${response.statusText}`);
                        }
                        
                        // Update UI either way since we've already updated localStorage
                        currentFile = newName;
                        contentTitle.textContent = newName;
                        fetchNotebookFiles(currentDirectory);
                    })
                    .catch(error => {
                        log(`Server error during rename: ${error.message}`);
                        // Still update UI since we've already updated localStorage
                        currentFile = newName;
                        contentTitle.textContent = newName;
                        fetchNotebookFiles(currentDirectory);
                    });
                }
            });
            
            // Delete button
            deleteBtn.addEventListener('click', () => {
                if (!currentFile) return;
                
                if (confirm(`Are you sure you want to delete ${currentFile}?`)) {
                    log(`Deleting ${currentFile}...`);
                    
                    // Get the current file's local storage key
                    const localStorageKey = `content_${currentDirectory}_${currentFile}`;
                    
                    // Also clean up history and any tags
                    const historyKey = `history_${currentDirectory}_${currentFile}`;
                    const tagsKey = `tags_${currentDirectory}_${currentFile}`;
                    
                    // Remove all related localStorage entries
                    const keysToRemove = [localStorageKey, historyKey, tagsKey];
                    keysToRemove.forEach(key => {
                        if (localStorage.getItem(key)) {
                            localStorage.removeItem(key);
                            log(`Removed from storage: ${key}`);
                        }
                    });
                    
                    // Remove from recent files list if present
                    recentFiles = recentFiles.filter(entry => 
                        !(entry.directory === currentDirectory && entry.file === currentFile)
                    );
                    localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                    displayRecentFiles();
                    
                    // Clear the current view
                    contentTitle.textContent = 'Select a file to view';
                    contentDisplay.textContent = 'File content will appear here...';
                    contentDisplay.innerHTML = 'File content will appear here...';
                    fileOperations.style.display = 'none';
                    fileTags.style.display = 'none';
                    
                    // Important: Set currentFile to null so the UI knows no file is selected
                    currentFile = null;
                    
                    log('File deleted successfully');
                    
                    // Check if this was the last file in the directory
                    const remainingFilesInDir = Object.keys(localStorage).filter(key => 
                        key.startsWith(`content_${currentDirectory}_`)
                    );
                    
                    // Refresh both directories and files lists
                    if (remainingFilesInDir.length === 0) {
                        // If this was the last file, also refresh directories
                        log('Last file in directory was deleted - refreshing directory list');
                        fetchNotebookDirectories();
                    }
                    
                    // Always refresh the file list to show the current state
                    fetchNotebookFiles(currentDirectory);
                    
                    // Also try to delete on server, but don't wait for the response
                    fetch(`${API_BASE_URL}/notebooks/${currentDirectory}/${currentFile}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if (response.ok) {
                            log('Server confirmed deletion');
                        } else {
                            log(`Server note: ${response.statusText}`);
                        }
                    })
                    .catch(error => {
                        log(`Server error: ${error.message}`);
                    });
                }
            });
            
            // Global search
            // Global search has been replaced by unified search
            /* globalSearch.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = globalSearch.value.trim();
                    if (searchTerm.length < 2) {
                        alert('Please enter at least 2 characters to search');
                        return;
                    }
                    
                    log(`Searching for: ${searchTerm}`);
                    
                    // Use the search API
                    fetch(`${API_BASE_URL}/search?q=${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.results && data.results.length > 0) {
                            log(`Found ${data.results.length} results for "${searchTerm}"`);
                            
                            // Display search results in the content area
                            contentTitle.textContent = `Search Results: ${searchTerm}`;
                            contentDisplay.innerHTML = '';
                            
                            // Create search results container
                            const resultsContainer = document.createElement('div');
                            resultsContainer.className = 'search-results';
                            
                            // Add each result
                            data.results.forEach(result => {
                                const resultItem = document.createElement('div');
                                resultItem.className = 'search-result-item';
                                resultItem.style.padding = '15px';
                                resultItem.style.marginBottom = '15px';
                                resultItem.style.borderBottom = '1px solid #eee';
                                
                                resultItem.innerHTML = `
                                    <h3 style="margin-top: 0;">
                                        <span style="color: #14418B; cursor: pointer;" class="result-file" 
                                              data-directory="${result.category}" 
                                              data-file="${result.file}">
                                            ${result.file} (${result.category})
                                        </span>
                                    </h3>
                                    <div style="background-color: #f9f9f9; padding: 10px; border-radius: 4px; margin-top: 5px;">
                                        ${result.excerpt}
                                    </div>
                                `;
                                
                                resultsContainer.appendChild(resultItem);
                            });
                            
                            // Add click handlers for search results
                            resultsContainer.addEventListener('click', (e) => {
                                if (e.target.classList.contains('result-file')) {
                                    const directory = e.target.getAttribute('data-directory');
                                    const file = e.target.getAttribute('data-file');
                                    
                                    // If it's a different directory than the current one
                                    if (directory !== currentDirectory) {
                                        directorySelect.value = directory;
                                        fetchNotebookFiles(directory, file.replace('.txt', ''));
                                    } else {
                                        // Just load the file in the current directory
                                        fetchNotebookContent(directory, file);
                                        
                                        // Highlight the file in the file list
                                        document.querySelectorAll('.file-item').forEach(item => {
                                            if (item.getAttribute('data-filename') === file.toLowerCase()) {
                                                item.classList.add('active');
                                            } else {
                                                item.classList.remove('active');
                                            }
                                        });
                                    }
                                }
                            });
                            
                            contentDisplay.appendChild(resultsContainer);
                            
                            // Hide file operations when viewing search results
                            fileOperations.style.display = 'none';
                            fileTags.style.display = 'none';
                        } else {
                            log(`No results found for "${searchTerm}"`);
                            
                            contentTitle.textContent = `Search Results: ${searchTerm}`;
                            contentDisplay.innerHTML = `<div style="padding: 20px; text-align: center;">No results found for "${searchTerm}"</div>`;
                            
                            // Hide file operations
                            fileOperations.style.display = 'none';
                            fileTags.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        log(`Error during search: ${error.message}`);
                    });
                }
            }); */
        }
        
        // Load tags for specific directory
        function loadDirectoryTags(directory) {
            fetch(`${API_BASE_URL}/notebooks/${directory}/tags`)
                .then(response => response.json())
                .then(data => {
                    if (data.tags && Array.isArray(data.tags)) {
                        const tagsContainer = document.getElementById('tags-container');
                        tagsContainer.innerHTML = '';
                        
                        if (data.tags.length === 0) {
                            tagsContainer.innerHTML = '<div style="color: #888; font-style: italic;">No tags in this directory</div>';
                            return;
                        }
                        
                        // Sort tags alphabetically
                        data.tags.sort();
                        
                        // Add each tag with count
                        data.tags.forEach(tagData => {
                            const tagSpan = document.createElement('span');
                            tagSpan.className = 'tag';
                            tagSpan.textContent = `${tagData.name} (${tagData.count})`;
                            tagSpan.setAttribute('data-tag', tagData.name);
                            tagSpan.style.cursor = 'pointer';
                            
                            // Add click handler for filtering
                            tagSpan.addEventListener('click', () => {
                                // Toggle active state
                                tagSpan.classList.toggle('active');
                                
                                // Apply tag filtering
                                applyTagFiltering();
                            });
                            
                            tagsContainer.appendChild(tagSpan);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading directory tags:', error);
                });
        }
        
        // Load all available tags
        function loadAllTags() {
            fetch(`${API_BASE_URL}/tags`)
                .then(response => response.json())
                .then(data => {
                    if (data.tags && Array.isArray(data.tags)) {
                        const tagsContainer = document.getElementById('tags-container');
                        tagsContainer.innerHTML = '';
                        
                        if (data.tags.length === 0) {
                            tagsContainer.innerHTML = '<div style="color: #888; font-style: italic;">No tags available</div>';
                            return;
                        }
                        
                        // Sort tags alphabetically
                        data.tags.sort();
                        
                        // Add each tag
                        data.tags.forEach(tag => {
                            const tagSpan = document.createElement('span');
                            tagSpan.className = 'tag';
                            tagSpan.textContent = tag;
                            tagSpan.style.cursor = 'pointer';
                            
                            // Add click handler for filtering
                            tagSpan.addEventListener('click', () => {
                                // Toggle active state
                                tagSpan.classList.toggle('active');
                                
                                // Apply tag filtering
                                applyTagFiltering();
                            });
                            
                            tagsContainer.appendChild(tagSpan);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading tags:', error);
                });
        }
        
        // Apply tag filtering to file list
        function applyTagFiltering() {
            const activeTags = [...document.querySelectorAll('#tags-container .tag.active')].map(tag => 
                tag.getAttribute('data-tag') || tag.textContent.trim().replace(/ \(\d+\)$/, '')
            );
            
            // If no active tags, show all files
            if (activeTags.length === 0) {
                document.querySelectorAll('#file-items .file-item').forEach(item => {
                    item.style.display = 'block';
                });
                return;
            }
            
            // Hide all files first
            document.querySelectorAll('#file-items .file-item').forEach(item => {
                item.style.display = 'none';
            });
            
            // For each file, check if it has any active tags
            document.querySelectorAll('#file-items .file-item').forEach(item => {
                const fileName = item.getAttribute('data-filename');
                
                // Fetch tags for this file
                fetch(`${API_BASE_URL}/notebooks/${currentDirectory}/${fileName}/tags`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.tags && Array.isArray(data.tags)) {
                            // Check if file has any of the active tags
                            const hasMatchingTag = activeTags.some(tag => data.tags.includes(tag));
                            
                            if (hasMatchingTag) {
                                item.style.display = 'block';
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`Error fetching tags for ${fileName}:`, error);
                    });
            });
        }
        
        // Apply formatting to editor
        function applyFormat(format) {
            if (!contentEditor) return;
            
            const textarea = contentEditor;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let replacement = '';
            
            switch (format) {
                case 'bold':
                    replacement = `**${selectedText}**`;
                    break;
                case 'italic':
                    replacement = `*${selectedText}*`;
                    break;
                case 'heading':
                    replacement = `\n## ${selectedText}\n`;
                    break;
                case 'list-ul':
                    replacement = selectedText.split('\n').map(line => `- ${line}`).join('\n');
                    break;
                case 'list-ol':
                    replacement = selectedText.split('\n').map((line, i) => `${i+1}. ${line}`).join('\n');
                    break;
                case 'link':
                    replacement = `[${selectedText}](url)`;
                    break;
                case 'image':
                    replacement = `![${selectedText}](image-url)`;
                    break;
                case 'code':
                    if (selectedText.includes('\n')) {
                        replacement = '```\n' + selectedText + '\n```';
                    } else {
                        replacement = '`' + selectedText + '`';
                    }
                    break;
                default:
                    replacement = selectedText;
            }
            
            // Replace the selected text with the markdown-formatted text
            textarea.value = 
                textarea.value.substring(0, start) + 
                replacement + 
                textarea.value.substring(end);
            
            // Update the selection to encompass the new text
            textarea.selectionStart = start;
            textarea.selectionEnd = start + replacement.length;
            
            // Focus the textarea again
            textarea.focus();
        }
        
        // Initialize everything
        function initialize() {
            log('Application initialized');
            fetchNotebookDirectories();
            setupEventListeners();
            initUnifiedSearch(); // Use unified search instead of file filter
            loadAllTags();
            displayRecentFiles();
            initializeViewModeToggles();
        }
        
        // Start the application
        initialize();
        
        // Comprehensive layout and content repair
        setTimeout(() => {
            console.log('[REPAIR] Starting emergency repair process');
            
            // Force critical styles
            const styleOverride = document.createElement('style');
            styleOverride.id = 'emergency-layout-fix';
            styleOverride.textContent = `
                /* Editor Fidelity Preservation */
                .editor-toolbar {
                    position: static !important;
                    z-index: 100 !important;
                    padding: 6px 8px !important;
                    background-color: #f9f9f9 !important;
                    border-bottom: 1px solid #eee !important;
                    border-top-left-radius: 3px !important;
                    border-top-right-radius: 3px !important;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.03) !important;
                    display: flex !important;
                    flex-wrap: wrap !important;
                    align-items: center !important;
                    transition: all 0.3s ease !important;
                    opacity: 0.9 !important;
                    font-size: 12px !important;
                    width: 100% !important;
                }
                
                /* Improved Preview Toggle */
                #preview-toggle-btn {
                    position: absolute !important;
                    top: 10px !important;
                    right: 10px !important;
                    z-index: 150 !important;
                    background-color: #f5f5f5 !important;
                    border: 1px solid #ddd !important;
                    border-radius: 4px !important;
                    padding: 5px 10px !important;
                    font-size: 13px !important;
                    color: #555 !important;
                    cursor: pointer !important;
                    transition: all 0.2s ease !important;
                    display: flex !important;
                    align-items: center !important;
                    gap: 5px !important;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
                    font-weight: normal !important;
                    height: auto !important;
                    line-height: normal !important;
                    min-width: auto !important;
                    min-height: auto !important;
                    width: auto !important;
                }
                
                #preview-toggle-btn:hover {
                    background-color: #e9e9e9 !important;
                    border-color: #ccc !important;
                }
                
                #preview-toggle-btn.previewing {
                    background-color: #14418B !important;
                    color: white !important;
                    border-color: #0a2859 !important;
                    box-shadow: 0 1px 5px rgba(20,65,139,0.3) !important;
                }
                
                #preview-toggle-btn i {
                    margin-right: 5px !important;
                }
                
                /* Improved TOC styling */
                #toc {
                    background-color: #f9f9f9 !important;
                    border: 1px solid #eee !important;
                    border-radius: 6px !important;
                    padding: 12px !important;
                    margin: 0 0 20px 0 !important;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.03) !important;
                }
                
                #toc-heading {
                    margin: 0 0 10px 0 !important;
                    font-size: 16px !important;
                    color: #555 !important;
                    display: flex !important;
                    align-items: center !important;
                    justify-content: space-between !important;
                }
                
                #toc-list {
                    margin: 0 !important;
                    padding-left: 20px !important;
                }
                
                #toc-list li {
                    margin-bottom: 5px !important;
                }
                
                #toc-list a {
                    color: #555 !important;
                    text-decoration: none !important;
                    transition: all 0.2s ease !important;
                }
                
                #toc-list a:hover {
                    color: #14418B !important;
                    text-decoration: underline !important;
                }
                
                .toolbar-btn {
                    display: inline-block !important;
                    text-align: center !important;
                    min-width: 30px !important;
                    height: 30px !important;
                    padding: 0 8px !important;
                    border-radius: 2px !important;
                    background: none !important;
                    border: none !important;
                    color: #555 !important;
                    cursor: pointer !important;
                    margin-right: 2px !important;
                    line-height: 30px !important;
                    transition: all 0.2s ease !important;
                }
                
                .toolbar-btn:hover {
                    background-color: #e9e9e9 !important;
                    color: #333 !important;
                }
                
                .toolbar-divider {
                    display: inline-block !important;
                    width: 1px !important;
                    height: 20px !important;
                    background-color: #ddd !important;
                    margin: 0 5px !important;
                    vertical-align: middle !important;
                }
                
                #content-editor {
                    width: 100% !important;
                    min-height: 400px !important;
                    font-family: 'Courier New', monospace !important;
                    line-height: 1.5 !important;
                    padding: 15px !important;
                    font-size: 14px !important;
                    resize: vertical !important;
                    border: none !important;
                    outline: none !important;
                    flex-grow: 1 !important;
                    box-sizing: border-box !important;
                }
                
                .preview-mode {
                    background-color: #fff !important;
                    padding: 30px !important;
                    border-radius: 8px !important;
                    border: 1px solid #eee !important;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.05) !important;
                    font-family: 'Raleway', sans-serif !important;
                    line-height: 1.6 !important;
                    max-width: 100% !important;
                    margin: 0 auto !important;
                    transition: all 0.3s ease-in-out !important;
                }
                
                /* Preview content transitions */
                #preview-content {
                    animation: fadeIn 0.3s ease-in-out !important;
                }
                
                @keyframes fadeIn {
                    from { opacity: 0 !important; transform: translateY(10px) !important; }
                    to { opacity: 1 !important; transform: translateY(0) !important; }
                }
                
                /* Reset action-button styles specifically for toolbar */
                .editor-toolbar .action-button,
                .editor-toolbar button[id$="-btn"] {
                    font-size: inherit !important;
                    font-weight: normal !important;
                    padding: 0 8px !important;
                    background: none !important;
                    border: none !important;
                    box-shadow: none !important;
                    margin: 0 2px !important;
                }
                
                /* Ensure edit view displays properly */
                #edit-view {
                    display: flex !important;
                    flex-direction: column !important;
                    height: 100% !important;
                }
                body {
                    min-height: 100vh;
                    overflow-x: hidden;
                    margin: 0;
                    padding: 0;
                    display: flex;
                    flex-direction: column;
                }
                
                .container {
                    display: flex !important;
                    flex-direction: row !important;
                    width: 100% !important;
                    max-width: 1200px !important;
                    margin: 1rem auto !important;
                    padding: 0 1rem !important;
                    flex: 1 !important;
                    min-height: 0 !important;
                }
                
                @media (max-width: 900px) {
                    .container {
                        flex-direction: column !important;
                    }
                }
                
                .sidebar {
                    width: 300px !important;
                    min-width: 300px !important;
                    max-width: 300px !important;
                    flex: 0 0 300px !important;
                    overflow: auto !important;
                    box-sizing: border-box !important;
                    height: auto !important;
                    display: block !important;
                }
                
                @media (max-width: 900px) {
                    .sidebar {
                        width: 100% !important;
                        min-width: 100% !important;
                        max-width: 100% !important;
                        flex: none !important;
                    }
                }
                
                .content {
                    flex: 1 !important;
                    min-width: 0 !important;
                    width: auto !important;
                    overflow: auto !important;
                    box-sizing: border-box !important;
                    display: flex !important;
                    flex-direction: column !important;
                }
                
                #content-display, .content-display {
                    flex: 1 !important;
                    min-height: 300px !important;
                    overflow: auto !important;
                    box-sizing: border-box !important;
                    display: block !important;
                    background-color: #f9f9f9 !important;
                    padding: 20px !important;
                    border-radius: 8px !important;
                    border: 1px solid #eee !important;
                    margin-top: 15px !important;
                }
                
                .content-placeholder {
                    text-align: center !important;
                    padding: 40px !important;
                    color: #666 !important;
                }
                
                .file-item {
                    cursor: pointer !important;
                    padding: 8px !important;
                    border-bottom: 1px solid #eee !important;
                }
                
                .file-item:hover {
                    background-color: #f5f5f5 !important;
                }
                
                .file-item.active {
                    background-color: #e6f0ff !important;
                    border-left: 3px solid #14418B !important;
                }
            `;
            document.head.appendChild(styleOverride);
            console.log('[REPAIR] Applied emergency styles');
            
            // Fix potential DOM rendering issues
            const container = document.querySelector('.container');
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const contentDisplay = document.getElementById('content-display');
            
            if (container && sidebar && content) {
                console.log('[REPAIR] Critical layout elements found');
                
                // Force sidebar to always be first child, content second
                if (container.children[0] !== sidebar || container.children[1] !== content) {
                    console.log('[REPAIR] Fixing container child order');
                    container.innerHTML = '';
                    container.appendChild(sidebar);
                    container.appendChild(content);
                }
            } else {
                console.error('[REPAIR] Missing critical layout elements - cannot fully recover');
            }
            
            // Fix file loading issues
            if (contentDisplay) {
                console.log('[REPAIR] Content display element found');
                
                // Check if content area is empty
                const isEmpty = contentDisplay.textContent.trim() === 'File content will appear here...' || 
                               contentDisplay.textContent.trim() === '' ||
                               contentDisplay.textContent.includes('Select a file from the sidebar');
                
                if (isEmpty) {
                    console.log('[REPAIR] Content display is empty');
                    
                    // Fix file click handlers
                    const fileItems = document.querySelectorAll('.file-item');
                    let atleastOneFixed = false;
                    
                    fileItems.forEach(item => {
                        if (!item.onclick) {
                            item.onclick = function() {
                                console.log('[REPAIR] Using repaired click handler');
                                
                                // Mark as active
                                document.querySelectorAll('.file-item').forEach(fi => fi.classList.remove('active'));
                                this.classList.add('active');
                                
                                // Get filename
                                const filename = this.getAttribute('data-filename') || this.textContent.trim();
                                const directory = this.getAttribute('data-directory') || 'Notebooks';
                                
                                // Try to load content
                                if (typeof fetchNotebookContent === 'function') {
                                    fetchNotebookContent(directory, filename);
                                } else {
                                    console.error('[REPAIR] fetchNotebookContent function not available');
                                    
                                    // Fallback content loading
                                    contentDisplay.innerHTML = `
                                        <h2>${filename}</h2>
                                        <div style="padding: 15px; margin-top: 20px; background: #f5f5f5; border-radius: 4px;">
                                            <p>Content loading function is unavailable.</p>
                                            <p>Selected file: ${filename}</p>
                                            <p>Directory: ${directory}</p>
                                        </div>
                                    `;
                                }
                            };
                            atleastOneFixed = true;
                        }
                    });
                    
                    console.log(`[REPAIR] Fixed click handlers for ${atleastOneFixed ? 'some' : 'no'} file items`);
                    
                    // Try to load most recent file
                    try {
                        const recentFiles = JSON.parse(localStorage.getItem('recentFiles') || '[]');
                        
                        if (recentFiles.length > 0) {
                            const recentFile = recentFiles[0];
                            console.log('[REPAIR] Auto-loading most recent file:', recentFile.filename);
                            
                            // Find this file in the list
                            let foundItem = null;
                            fileItems.forEach(item => {
                                const filename = item.getAttribute('data-filename') || item.textContent.trim();
                                if (filename === recentFile.filename) {
                                    foundItem = item;
                                }
                            });
                            
                            if (foundItem) {
                                console.log('[REPAIR] Triggering click on found item');
                                foundItem.click();
                            } else if (typeof fetchNotebookContent === 'function') {
                                console.log('[REPAIR] Direct content fetch');
                                fetchNotebookContent(recentFile.directory, recentFile.filename);
                            } else {
                                throw new Error('Cannot load recent file');
                            }
                        } else {
                            throw new Error('No recent files');
                        }
                    } catch (err) {
                        console.log('[REPAIR] Could not load recent file:', err.message);
                        
                        // Show welcome message
                        contentDisplay.innerHTML = `
                            <div class="content-placeholder">
                                <h3 style="margin-bottom: 20px; color: #14418B;">Welcome to Constellation Viewer</h3>
                                <p>Select a file from the sidebar to view its contents.</p>
                                <p style="margin-top: 15px; font-size: 13px;">You can also create a new file using the "New File" button.</p>
                            </div>
                        `;
                    }
                } else {
                    console.log('[REPAIR] Content display already has content');
                }
            } else {
                console.error('[REPAIR] Content display element missing');
            }
            
            // Ensure editor functionality remains intact
            try {
                const contentEditor = document.getElementById('content-editor');
                const editView = document.getElementById('edit-view');
                const readView = document.getElementById('read-view');
                const saveBtn = document.getElementById('save-btn');
                
                // Create enhanced preview toggle
                const createPreviewToggle = () => {
                    // Only create if it doesn't exist yet
                    if (!document.getElementById('preview-toggle-btn') && editView) {
                        const previewToggleBtn = document.createElement('button');
                        previewToggleBtn.id = 'preview-toggle-btn';
                        previewToggleBtn.innerHTML = '<i class="fas fa-eye"></i> Preview (Ctrl+P)';
                        previewToggleBtn.title = 'Toggle between edit and preview modes';
                        
                        // Add to edit view
                        editView.appendChild(previewToggleBtn);
                        
                        // Create a preview container if it doesn't exist
                        let previewContainer = document.getElementById('preview-container');
                        if (!previewContainer) {
                            previewContainer = document.createElement('div');
                            previewContainer.id = 'preview-container';
                            previewContainer.className = 'preview-mode';
                            previewContainer.style.display = 'none';
                            previewContainer.style.position = 'absolute';
                            previewContainer.style.top = '0';
                            previewContainer.style.left = '0';
                            previewContainer.style.right = '0';
                            previewContainer.style.bottom = '0';
                            previewContainer.style.zIndex = '5';
                            previewContainer.style.overflowY = 'auto';
                            previewContainer.style.padding = '25px';
                            previewContainer.style.backgroundColor = 'white';
                            
                            // Add TOC to preview container
                            const tocContainer = document.createElement('div');
                            tocContainer.id = 'preview-toc';
                            tocContainer.style.position = 'sticky';
                            tocContainer.style.top = '10px';
                            tocContainer.style.float = 'right';
                            tocContainer.style.width = '250px';
                            tocContainer.style.marginLeft = '20px';
                            tocContainer.style.marginBottom = '20px';
                            tocContainer.style.padding = '15px';
                            tocContainer.style.backgroundColor = '#f8fafd';
                            tocContainer.style.border = '1px solid #dce3f0';
                            tocContainer.style.borderRadius = '6px';
                            tocContainer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                            tocContainer.style.fontSize = '0.9rem';
                            tocContainer.style.zIndex = '10';
                            
                            tocContainer.innerHTML = `
                                <div id="toc-heading" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                                    <span style="font-weight: 600; color: #14418B;"><i class="fas fa-list"></i> Table of Contents</span>
                                    <button id="toggle-toc-btn" style="background: none; border: none; cursor: pointer; color: #888; width: auto; padding: 2px 5px; margin: 0;">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                                <ol id="preview-toc-list" style="margin-top: 10px; padding-left: 20px;"></ol>
                            `;
                            
                            // Add preview content area
                            const previewContent = document.createElement('div');
                            previewContent.id = 'preview-content';
                            previewContent.style.paddingTop = '20px';
                            
                            // Add preview layout container
                            const previewLayout = document.createElement('div');
                            previewLayout.style.display = 'flex';
                            previewLayout.style.flexDirection = 'column';
                            
                            previewLayout.appendChild(previewContent);
                            previewContainer.appendChild(tocContainer);
                            previewContainer.appendChild(previewLayout);
                            
                            // Add to edit view
                            editView.appendChild(previewContainer);
                            
                            // TOC toggle functionality
                            const toggleTocBtn = document.getElementById('toggle-toc-btn');
                            const previewTocList = document.getElementById('preview-toc-list');
                            
                            if (toggleTocBtn && previewTocList) {
                                toggleTocBtn.addEventListener('click', function() {
                                    if (previewTocList.style.display === 'none') {
                                        previewTocList.style.display = 'block';
                                        toggleTocBtn.innerHTML = '<i class="fas fa-minus"></i>';
                                    } else {
                                        previewTocList.style.display = 'none';
                                        toggleTocBtn.innerHTML = '<i class="fas fa-plus"></i>';
                                    }
                                });
                            }
                        }
                        
                        // Add keyboard shortcut for toggling preview
                        document.addEventListener('keydown', function(e) {
                            // Check if Ctrl+P or Cmd+P is pressed
                            if ((e.ctrlKey || e.metaKey) && e.key === 'p' && document.getElementById('preview-toggle-btn')) {
                                e.preventDefault(); // Prevent browser print dialog
                                document.getElementById('preview-toggle-btn').click();
                            }
                        });
                        
                        // Toggle between edit and preview
                        previewToggleBtn.addEventListener('click', function() {
                            const editorContainer = document.getElementById('editor-container');
                            const previewContainer = document.getElementById('preview-container');
                            
                            if (!previewContainer || !editorContainer) return;
                            
                            const isPreview = previewContainer.style.display !== 'none';
                            
                            if (isPreview) {
                                // Switch to edit mode
                                previewContainer.style.display = 'none';
                                editorContainer.style.display = 'flex';
                                previewToggleBtn.innerHTML = '<i class="fas fa-eye"></i> Preview (Ctrl+P)';
                                previewToggleBtn.classList.remove('previewing');
                            } else {
                                // Switch to preview mode
                                previewContainer.style.display = 'block';
                                
                                // Make sure editor toolbar is still visible
                                const editorToolbar = document.querySelector('.editor-toolbar');
                                if (editorToolbar) {
                                    editorToolbar.style.display = 'flex';
                                }
                                
                                // Generate preview content with Markdown
                                if (contentEditor && window.marked) {
                                    const markdown = contentEditor.value;
                                    const previewContent = document.getElementById('preview-content');
                                    
                                    if (previewContent) {
                                        // Render markdown
                                        try {
                                            previewContent.innerHTML = window.marked(markdown);
                                            console.log('[REPAIR] Markdown rendered successfully');
                                            
                                            // Generate TOC
                                            const tocList = document.getElementById('preview-toc-list');
                                            if (tocList) {
                                                tocList.innerHTML = '';
                                                
                                                // Find all headings in the preview content
                                                const headings = previewContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
                                                
                                                if (headings.length > 0) {
                                                    // Sort headings by their position in the document
                                                    const sortedHeadings = Array.from(headings).sort((a, b) => {
                                                        return a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING ? -1 : 1;
                                                    });
                                                    
                                                    sortedHeadings.forEach((heading, index) => {
                                                        // Add ID to heading if it doesn't have one
                                                        if (!heading.id) {
                                                            heading.id = `heading-${index}`;
                                                        }
                                                        
                                                        // Create TOC item
                                                        const li = document.createElement('li');
                                                        const a = document.createElement('a');
                                                        a.href = `#${heading.id}`;
                                                        a.textContent = heading.textContent;
                                                        
                                                        // Indent based on heading level
                                                        const level = parseInt(heading.tagName.substring(1)) - 1;
                                                        a.style.paddingLeft = level * 15 + 'px';
                                                        li.style.marginLeft = level * 10 + 'px';
                                                        li.style.fontSize = (16 - level) + 'px';
                                                        
                                                        // When TOC link is clicked, scroll to heading
                                                        a.addEventListener('click', function(e) {
                                                            e.preventDefault();
                                                            heading.scrollIntoView({ behavior: 'smooth' });
                                                        });
                                                        
                                                        li.appendChild(a);
                                                        tocList.appendChild(li);
                                                    });
                                                    
                                                    // Show TOC
                                                    document.getElementById('preview-toc').style.display = 'block';
                                                } else {
                                                    // Hide TOC if no headings
                                                    document.getElementById('preview-toc').style.display = 'none';
                                                }
                                            }
                                        } catch (err) {
                                            console.error('[REPAIR] Error rendering markdown:', err);
                                            previewContent.innerHTML = `<div class="error">Error rendering preview: ${err.message}</div>`;
                                        }
                                    }
                                }
                                
                                previewToggleBtn.innerHTML = '<i class="fas fa-edit"></i> Edit (Ctrl+P)';
                                previewToggleBtn.classList.add('previewing');
                            }
                        });
                        
                        console.log('[REPAIR] Enhanced preview toggle added');
                    }
                };
                
                // Create the enhanced preview toggle
                createPreviewToggle();
                
                // Fix editor tab switching
                const fixEditTabSwitching = () => {
                    const readTab = document.getElementById('read-tab');
                    const editTab = document.getElementById('edit-tab');
                    const historyTab = document.getElementById('history-tab');
                    
                    if (readTab && editTab && historyTab) {
                        // Ensure proper tab click behavior
                        if (!readTab.hasAttribute('data-fixed') && readView) {
                            readTab.setAttribute('data-fixed', 'true');
                            readTab.addEventListener('click', function() {
                                console.log('[REPAIR] Read tab clicked');
                                // Show read view
                                if (editView) editView.style.display = 'none';
                                if (readView) readView.style.display = 'block';
                                
                                // Update active tab
                                readTab.classList.add('active');
                                editTab.classList.remove('active');
                                historyTab.classList.remove('active');
                            });
                        }
                        
                        if (!editTab.hasAttribute('data-fixed') && editView) {
                            editTab.setAttribute('data-fixed', 'true');
                            editTab.addEventListener('click', function() {
                                console.log('[REPAIR] Edit tab clicked');
                                // Show edit view
                                if (readView) readView.style.display = 'none';
                                if (editView) editView.style.display = 'flex';
                                
                                // Update active tab
                                readTab.classList.remove('active');
                                editTab.classList.add('active');
                                historyTab.classList.remove('active');
                            });
                        }
                    }
                };
                
                // Fix edit/save functionality
                if (contentEditor && saveBtn && !saveBtn.hasAttribute('data-fixed')) {
                    saveBtn.setAttribute('data-fixed', 'true');
                    console.log('[REPAIR] Enhanced save functionality');
                    
                    // Make sure save button works
                    saveBtn.addEventListener('click', function() {
                        // If original click handler runs, great
                        // If not, this will be a fallback
                        setTimeout(() => {
                            const content = contentEditor.value;
                            const currentFile = document.querySelector('.file-item.active');
                            if (currentFile && content) {
                                const filename = currentFile.getAttribute('data-filename') || currentFile.textContent.trim();
                                const directory = currentFile.getAttribute('data-directory') || 'Notebooks';
                                
                                try {
                                    // Try to save to localStorage as fallback
                                    localStorage.setItem(`content_${directory}_${filename}`, content);
                                    console.log('[REPAIR] Content saved to localStorage as fallback');
                                    
                                    // Add to recent files if not already there
                                    try {
                                        const recentFiles = JSON.parse(localStorage.getItem('recentFiles') || '[]');
                                        const isAlreadyInRecent = recentFiles.some(f => f.filename === filename && f.directory === directory);
                                        
                                        if (!isAlreadyInRecent) {
                                            recentFiles.unshift({ directory, filename, timestamp: Date.now() });
                                            if (recentFiles.length > 10) recentFiles.pop();
                                            localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                                        }
                                    } catch (e) {
                                        // Ignore recent files error
                                    }
                                    
                                    // Switch to read view to show saved content
                                    if (document.getElementById('read-tab')) {
                                        document.getElementById('read-tab').click();
                                    }
                                } catch (err) {
                                    console.error('[REPAIR] Save fallback failed:', err);
                                }
                            }
                        }, 300);
                    });
                }
                
                // Call fix for tab switching
                fixEditTabSwitching();
                
                // Monitor and fix tab switching
                const tabObserver = new MutationObserver(function(mutations) {
                    fixEditTabSwitching();
                });
                
                // Start observing the tabs area
                const tabsArea = document.querySelector('.wiki-tabs');
                if (tabsArea) {
                    tabObserver.observe(tabsArea, { 
                        childList: true, 
                        subtree: true,
                        attributes: true,
                        attributeFilter: ['class']
                    });
                }
                
                console.log('[REPAIR] Editor fidelity enhancements applied');
            } catch (err) {
                console.error('[REPAIR] Error while fixing editor:', err);
            }
            
            console.log('[REPAIR] Emergency repair process complete');
        }, 300);
    </script>
</body>
</html>